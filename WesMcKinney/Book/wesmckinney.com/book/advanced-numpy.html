<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Python for Data Analysis, 3E - Appendix A — Advanced NumPy</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ipython.html" rel="next">
<link href="./data-analysis-examples.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Python for Data Analysis, 3E - Appendix A — Advanced NumPy">
<meta property="og:description" content="">
<meta property="og:image" content="images/cover.png">
<meta property="og:site-name" content="Python for Data Analysis, 3E">
<meta name="twitter:title" content="Python for Data Analysis, 3E - Appendix A — Advanced NumPy">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="images/cover.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class='navbar-brand' href='/book/'>
    <span class="navbar-title">Python for Data Analysis, 3E</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class='nav-link' href='https://wesmckinney.com/archives' rel target>
 <span class="menu-text">Wes’s Blog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/wesmckinn" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/wesm/pydata-book" rel="" target="">
 <span class="dropdown-text">Data and Notebooks (GitHub)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://gitee.com/wesmckinn/pydata-book" rel="" target="">
 <span class="dropdown-text">Data and Notebooks (Gitee)</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href='/book/advanced-numpy'>Appendices</a></li><li class="breadcrumb-item"><a href='/book/advanced-numpy'><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Advanced NumPy</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/'>
 <span class="menu-text">About the Open Edition</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Chapters</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/preface'>
 <span class="menu-text">Preface</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/preliminaries'>
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preliminaries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/python-basics'>
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Python Language Basics, IPython, and Jupyter Notebooks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/python-builtin'>
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Built-In Data Structures, Functions, and Files</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/numpy-basics'>
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">NumPy Basics: Arrays and Vectorized Computation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/pandas-basics'>
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Getting Started with pandas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/accessing-data'>
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Loading, Storage, and File Formats</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/data-cleaning'>
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Data Cleaning and Preparation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/data-wrangling'>
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Data Wrangling: Join, Combine, and Reshape</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/plotting-and-visualization'>
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Plotting and Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/data-aggregation'>
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Data Aggregation and Group Operations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/time-series'>
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Time Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/modeling'>
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Introduction to Modeling Libraries in Python</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/data-analysis-examples'>
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Data Analysis Examples</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link active' href='/book/advanced-numpy'>
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Advanced NumPy</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a class='sidebar-item-text sidebar-link' href='/book/ipython'>
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">More on the IPython System</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar"><div class="quarto-margin-header"><div class="margin-header-item">
<a href="https://amzn.to/3DyLaJc"><img src="images/cover.png" class="img-fluid"></a>
<div data-ea-publisher="wesmckinneycom" data-ea-type="image">

</div>
</div></div>
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#numpy_ndarray_internals" id="toc-numpy_ndarray_internals" class="nav-link active" data-scroll-target="#numpy_ndarray_internals"><span class="header-section-number">A.1</span> ndarray Object Internals</a>
  <ul class="collapse">
  <li><a href="#numpy_dtype_hierarchy" id="toc-numpy_dtype_hierarchy" class="nav-link" data-scroll-target="#numpy_dtype_hierarchy">NumPy Data Type Hierarchy</a></li>
  </ul></li>
  <li><a href="#numpy_manips" id="toc-numpy_manips" class="nav-link" data-scroll-target="#numpy_manips"><span class="header-section-number">A.2</span> Advanced Array Manipulation</a>
  <ul class="collapse">
  <li><a href="#numpy_reshaping" id="toc-numpy_reshaping" class="nav-link" data-scroll-target="#numpy_reshaping">Reshaping Arrays</a></li>
  <li><a href="#numpy_c_vs_fortran" id="toc-numpy_c_vs_fortran" class="nav-link" data-scroll-target="#numpy_c_vs_fortran">C Versus FORTRAN Order</a></li>
  <li><a href="#numpy_concatenate_split" id="toc-numpy_concatenate_split" class="nav-link" data-scroll-target="#numpy_concatenate_split">Concatenating and Splitting Arrays</a></li>
  <li><a href="#numpy_tile_repeat" id="toc-numpy_tile_repeat" class="nav-link" data-scroll-target="#numpy_tile_repeat">Repeating Elements: tile and repeat</a></li>
  <li><a href="#numpy_indexing_apis" id="toc-numpy_indexing_apis" class="nav-link" data-scroll-target="#numpy_indexing_apis">Fancy Indexing Equivalents: take and put</a></li>
  </ul></li>
  <li><a href="#numpy_broadcasting" id="toc-numpy_broadcasting" class="nav-link" data-scroll-target="#numpy_broadcasting"><span class="header-section-number">A.3</span> Broadcasting</a>
  <ul class="collapse">
  <li><a href="#broadcasting_length1" id="toc-broadcasting_length1" class="nav-link" data-scroll-target="#broadcasting_length1">Broadcasting over Other Axes</a></li>
  <li><a href="#numpy_broadcasting_setting" id="toc-numpy_broadcasting_setting" class="nav-link" data-scroll-target="#numpy_broadcasting_setting">Setting Array Values by Broadcasting</a></li>
  </ul></li>
  <li><a href="#ufunc_advanced" id="toc-ufunc_advanced" class="nav-link" data-scroll-target="#ufunc_advanced"><span class="header-section-number">A.4</span> Advanced ufunc Usage</a>
  <ul class="collapse">
  <li><a href="#ufunc_methods" id="toc-ufunc_methods" class="nav-link" data-scroll-target="#ufunc_methods">ufunc Instance Methods</a></li>
  <li><a href="#ufunc_custom" id="toc-ufunc_custom" class="nav-link" data-scroll-target="#ufunc_custom">Writing New ufuncs in Python</a></li>
  </ul></li>
  <li><a href="#numpy_structured" id="toc-numpy_structured" class="nav-link" data-scroll-target="#numpy_structured"><span class="header-section-number">A.5</span> Structured and Record Arrays</a>
  <ul class="collapse">
  <li><a href="#numpy_structured_nested_varlength" id="toc-numpy_structured_nested_varlength" class="nav-link" data-scroll-target="#numpy_structured_nested_varlength">Nested Data Types and Multidimensional Fields</a></li>
  <li><a href="#numpy_why_structured_arrays" id="toc-numpy_why_structured_arrays" class="nav-link" data-scroll-target="#numpy_why_structured_arrays">Why Use Structured Arrays?</a></li>
  </ul></li>
  <li><a href="#numpy_advanced_sorting" id="toc-numpy_advanced_sorting" class="nav-link" data-scroll-target="#numpy_advanced_sorting"><span class="header-section-number">A.6</span> More About Sorting</a>
  <ul class="collapse">
  <li><a href="#numpy_indirect_sorts" id="toc-numpy_indirect_sorts" class="nav-link" data-scroll-target="#numpy_indirect_sorts">Indirect Sorts: argsort and lexsort</a></li>
  <li><a href="#numpy_more_sorting_methods" id="toc-numpy_more_sorting_methods" class="nav-link" data-scroll-target="#numpy_more_sorting_methods">Alternative Sort Algorithms</a></li>
  <li><a href="#numpy_partition" id="toc-numpy_partition" class="nav-link" data-scroll-target="#numpy_partition">Partially Sorting Arrays</a></li>
  <li><a href="#numpy_searchsorted" id="toc-numpy_searchsorted" class="nav-link" data-scroll-target="#numpy_searchsorted">numpy.searchsorted: Finding Elements in a Sorted Array</a></li>
  </ul></li>
  <li><a href="#numpy_numba" id="toc-numpy_numba" class="nav-link" data-scroll-target="#numpy_numba"><span class="header-section-number">A.7</span> Writing Fast NumPy Functions with Numba</a>
  <ul class="collapse">
  <li><a href="#numpy_numba_ufunc" id="toc-numpy_numba_ufunc" class="nav-link" data-scroll-target="#numpy_numba_ufunc">Creating Custom numpy.ufunc Objects with Numba</a></li>
  </ul></li>
  <li><a href="#numpy_io_advanced" id="toc-numpy_io_advanced" class="nav-link" data-scroll-target="#numpy_io_advanced"><span class="header-section-number">A.8</span> Advanced Array Input and Output</a>
  <ul class="collapse">
  <li><a href="#numpy_memmap" id="toc-numpy_memmap" class="nav-link" data-scroll-target="#numpy_memmap">Memory-Mapped Files</a></li>
  <li><a href="#numpy_other_hdf5" id="toc-numpy_other_hdf5" class="nav-link" data-scroll-target="#numpy_other_hdf5">HDF5 and Other Array Storage Options</a></li>
  </ul></li>
  <li><a href="#numpy_performance_quirks" id="toc-numpy_performance_quirks" class="nav-link" data-scroll-target="#numpy_performance_quirks"><span class="header-section-number">A.9</span> Performance Tips</a>
  <ul class="collapse">
  <li><a href="#numpy_contiguousness" id="toc-numpy_contiguousness" class="nav-link" data-scroll-target="#numpy_contiguousness">The Importance of Contiguous Memory</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="advanced_numpy" class="quarto-section-identifier">Appendix A — Advanced NumPy</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>This Open Access web version of <em>Python for Data Analysis 3rd Edition</em> is now available as a companion to the <a href="https://amzn.to/3DyLaJc">print and digital editions</a>. If you encounter any errata, <a href="https://oreilly.com/catalog/0636920519829/errata">please report them here</a>. Please note that some aspects of this site as produced by Quarto will differ from the formatting of the print and eBook versions from O’Reilly.</p>
<p>If you find the online edition of the book useful, please consider <a href="https://amzn.to/3DyLaJc">ordering a paper copy</a> or a <a href="https://www.ebooks.com/en-us/book/210644288/python-for-data-analysis/wes-mckinney/?affId=WES398681F">DRM-free eBook</a> to support the author. The content from this website may not be copied or reproduced. The code examples are MIT licensed and can be found on GitHub or Gitee.</p>
</div>
</div>
</div>
<p>In this appendix, I will go deeper into the NumPy library for array computing. This will include more internal details about the ndarray type and more advanced array manipulations and algorithms.</p>
<p>This appendix contains miscellaneous topics and does not necessarily need to be read linearly. Throughout the chapters, I will generate random data for many examples that will use the default random number generator in the <code>numpy.random</code> module:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">11</span>]: rng <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span><span class="dv">12345</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="numpy_ndarray_internals" class="level2" data-number="A.1">
<h2 data-number="A.1" class="anchored" data-anchor-id="numpy_ndarray_internals"><span class="header-section-number">A.1</span> ndarray Object Internals</h2>
<p>The NumPy ndarray provides a way to interpret a block of homogeneously typed data (either contiguous or strided) as a multidimensional array object. The data type, or <em>dtype</em>, determines how the data is interpreted as being floating point, integer, Boolean, or any of the other types we’ve been looking at.</p>
<p>Part of what makes ndarray flexible is that every array object is a <em>strided</em> view on a block of data. You might wonder, for example, how the array view <code>arr[::2, ::-1]</code> does not copy any data. The reason is that the ndarray is more than just a chunk of memory and a data type; it also has <em>striding</em> information that enables the array to move through memory with varying step sizes. More precisely, the ndarray internally consists of the following:</p>
<ul>
<li><p>A <em>pointer to data</em>—that is, a block of data in RAM or in a memory-mapped file</p></li>
<li><p>The <em>data type</em> or dtype describing fixed-size value cells in the array</p></li>
<li><p>A tuple indicating the array’s <em>shape</em></p></li>
<li><p>A tuple of <em>strides</em>—integers indicating the number of bytes to “step” in order to advance one element along a dimension</p></li>
</ul>
<p>See <a href="#fig-figure_ndarray">Figure&nbsp;<span>A.1</span></a> for a simple mock-up of the ndarray innards.</p>
<div id="fig-figure_ndarray" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/pda3_a001.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;A.1: The NumPy ndarray object</figcaption>
</figure>
</div>
<p>For example, a 10 × 5 array would have the shape <code>(10, 5)</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">12</span>]: np.ones((<span class="dv">10</span>, <span class="dv">5</span>)).shape</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">12</span>]: (<span class="dv">10</span>, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A typical (C order) 3 × 4 × 5 array of <code>float64</code> (8-byte) values has the strides <code>(160, 40, 8)</code> (knowing about the strides can be useful because, in general, the larger the strides on a particular axis, the more costly it is to perform computation along that axis):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">13</span>]: np.ones((<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>), dtype<span class="op">=</span>np.float64).strides</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">13</span>]: (<span class="dv">160</span>, <span class="dv">40</span>, <span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>While it is rare that a typical NumPy user would be interested in the array strides, they are needed to construct "zero-copy" array views. Strides can even be negative, which enables an array to move "backward" through memory (this would be the case, for example, in a slice like <code>obj[::-1]</code> or <code>obj[:, ::-1]</code>).</p>
<section id="numpy_dtype_hierarchy" class="level3">
<h3 class="anchored" data-anchor-id="numpy_dtype_hierarchy">NumPy Data Type Hierarchy</h3>
<p>You may occasionally have code that needs to check whether an array contains integers, floating-point numbers, strings, or Python objects. Because there are multiple types of floating-point numbers (<code>float16</code> through <code>float128</code>), checking that the data type is among a list of types would be very verbose. Fortunately, the data types have superclasses, such as <code>np.integer</code> and <code>np.floating</code>, which can be used with the <code>np.issubdtype</code> function:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">14</span>]: ints <span class="op">=</span> np.ones(<span class="dv">10</span>, dtype<span class="op">=</span>np.uint16)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">15</span>]: floats <span class="op">=</span> np.ones(<span class="dv">10</span>, dtype<span class="op">=</span>np.float32)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">16</span>]: np.issubdtype(ints.dtype, np.integer)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">16</span>]: <span class="va">True</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">17</span>]: np.issubdtype(floats.dtype, np.floating)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">17</span>]: <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can see all of the parent classes of a specific data type by calling the type’s <code>mro</code> method:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">18</span>]: np.float64.mro()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">18</span>]: </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>[numpy.float64,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a> numpy.floating,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a> numpy.inexact,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a> numpy.number,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a> numpy.generic,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a> <span class="bu">float</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a> <span class="bu">object</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Therefore, we also have:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">19</span>]: np.issubdtype(ints.dtype, np.number)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">19</span>]: <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Most NumPy users will never have to know about this, but it is occasionally useful. See <a href="#fig-figure_dtype_hierarchy">Figure&nbsp;<span>A.2</span></a> for a graph of the data type hierarchy and parent–subclass relationships.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div id="fig-figure_dtype_hierarchy" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/pda3_a002.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;A.2: The NumPy data type class hierarchy</figcaption>
</figure>
</div>
</section>
</section>
<section id="numpy_manips" class="level2" data-number="A.2">
<h2 data-number="A.2" class="anchored" data-anchor-id="numpy_manips"><span class="header-section-number">A.2</span> Advanced Array Manipulation</h2>
<p>There are many ways to work with arrays beyond fancy indexing, slicing, and Boolean subsetting. While much of the heavy lifting for data analysis applications is handled by higher-level functions in pandas, you may at some point need to write a data algorithm that is not found in one of the existing libraries.</p>
<section id="numpy_reshaping" class="level3">
<h3 class="anchored" data-anchor-id="numpy_reshaping">Reshaping Arrays</h3>
<p>In many cases, you can convert an array from one shape to another without copying any data. To do this, pass a tuple indicating the new shape to the <code>reshape</code> array instance method. For example, suppose we had a one-dimensional array of values that we wished to rearrange into a matrix (this is illustrated in <a href="#fig-figure_c_vs_fortran">Figure&nbsp;<span>A.3</span></a>):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">20</span>]: arr <span class="op">=</span> np.arange(<span class="dv">8</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">21</span>]: arr</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">21</span>]: array([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>])</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">22</span>]: arr.reshape((<span class="dv">4</span>, <span class="dv">2</span>))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">22</span>]: </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>array([[<span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">2</span>, <span class="dv">3</span>],</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">4</span>, <span class="dv">5</span>],</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">6</span>, <span class="dv">7</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-figure_c_vs_fortran" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/pda3_a003.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;A.3: Reshaping in C (row major) or FORTRAN (column major) order</figcaption>
</figure>
</div>
<p>A multidimensional array can also be reshaped:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">23</span>]: arr.reshape((<span class="dv">4</span>, <span class="dv">2</span>)).reshape((<span class="dv">2</span>, <span class="dv">4</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">23</span>]: </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>array([[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>],</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>One of the passed shape dimensions can be –1, in which case the value used for that dimension will be inferred from the data:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">24</span>]: arr <span class="op">=</span> np.arange(<span class="dv">15</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">25</span>]: arr.reshape((<span class="dv">5</span>, <span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">25</span>]: </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">3</span>,  <span class="dv">4</span>,  <span class="dv">5</span>],</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">6</span>,  <span class="dv">7</span>,  <span class="dv">8</span>],</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>],</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since an array’s <code>shape</code> attribute is a tuple, it can be passed to <code>reshape</code>, too:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">26</span>]: other_arr <span class="op">=</span> np.ones((<span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">27</span>]: other_arr.shape</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">27</span>]: (<span class="dv">3</span>, <span class="dv">5</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">28</span>]: arr.reshape(other_arr.shape)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">28</span>]: </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">3</span>,  <span class="dv">4</span>],</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">5</span>,  <span class="dv">6</span>,  <span class="dv">7</span>,  <span class="dv">8</span>,  <span class="dv">9</span>],</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The opposite operation of <code>reshape</code> from one-dimensional to a higher dimension is typically known as <em>flattening</em> or <em>raveling</em>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">29</span>]: arr <span class="op">=</span> np.arange(<span class="dv">15</span>).reshape((<span class="dv">5</span>, <span class="dv">3</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">30</span>]: arr</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">30</span>]: </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>],</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">3</span>,  <span class="dv">4</span>,  <span class="dv">5</span>],</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">6</span>,  <span class="dv">7</span>,  <span class="dv">8</span>],</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>],</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>]])</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">31</span>]: arr.ravel()</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">31</span>]: array([ <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">3</span>,  <span class="dv">4</span>,  <span class="dv">5</span>,  <span class="dv">6</span>,  <span class="dv">7</span>,  <span class="dv">8</span>,  <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>ravel</code> does not produce a copy of the underlying values if the values in the result were contiguous in the original array.</p>
<p>The <code>flatten</code> method behaves like <code>ravel</code> except it always returns a copy of the data:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">32</span>]: arr.flatten()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">32</span>]: array([ <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">3</span>,  <span class="dv">4</span>,  <span class="dv">5</span>,  <span class="dv">6</span>,  <span class="dv">7</span>,  <span class="dv">8</span>,  <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The data can be reshaped or raveled in different orders. This is a slightly nuanced topic for new NumPy users and is therefore the next subtopic.</p>
</section>
<section id="numpy_c_vs_fortran" class="level3">
<h3 class="anchored" data-anchor-id="numpy_c_vs_fortran">C Versus FORTRAN Order</h3>
<p>NumPy is able to adapt to many different layouts of your data in memory. By default, NumPy arrays are created in <em>row major</em> order. Spatially this means that if you have a two-dimensional array of data, the items in each row of the array are stored in adjacent memory locations. The alternative to row major ordering is <em>column major</em> order, which means that values within each column of data are stored in adjacent memory locations.</p>
<p>For historical reasons, row and column major order are also known as C and FORTRAN order, respectively. In the FORTRAN 77 language, matrices are all column major.</p>
<p>Functions like <code>reshape</code> and <code>ravel</code> accept an <code>order</code> argument indicating the order to use the data in the array. This is usually set to <code>'C'</code> or <code>'F'</code> in most cases (there are also less commonly used options <code>'A'</code> and <code>'K'</code>; see the NumPy documentation, and refer back to <a href="#fig-figure_c_vs_fortran">Figure&nbsp;<span>A.3</span></a> for an illustration of these options):</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">33</span>]: arr <span class="op">=</span> np.arange(<span class="dv">12</span>).reshape((<span class="dv">3</span>, <span class="dv">4</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">34</span>]: arr</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">34</span>]: </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">3</span>],</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">4</span>,  <span class="dv">5</span>,  <span class="dv">6</span>,  <span class="dv">7</span>],</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">8</span>,  <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>]])</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">35</span>]: arr.ravel()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">35</span>]: array([ <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">3</span>,  <span class="dv">4</span>,  <span class="dv">5</span>,  <span class="dv">6</span>,  <span class="dv">7</span>,  <span class="dv">8</span>,  <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">11</span>])</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">36</span>]: arr.ravel(<span class="st">'F'</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">36</span>]: array([ <span class="dv">0</span>,  <span class="dv">4</span>,  <span class="dv">8</span>,  <span class="dv">1</span>,  <span class="dv">5</span>,  <span class="dv">9</span>,  <span class="dv">2</span>,  <span class="dv">6</span>, <span class="dv">10</span>,  <span class="dv">3</span>,  <span class="dv">7</span>, <span class="dv">11</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Reshaping arrays with more than two dimensions can be a bit mind-bending (see <a href="#fig-figure_c_vs_fortran">Figure&nbsp;<span>A.3</span></a>). The key difference between C and FORTRAN order is the way in which the dimensions are walked:</p>
<dl>
<dt>C/row major order</dt>
<dd>
<p>Traverse higher dimensions <em>first</em> (e.g., axis 1 before advancing on axis 0).</p>
</dd>
<dt>FORTRAN/column major order</dt>
<dd>
<p>Traverse higher dimensions <em>last</em> (e.g., axis 0 before advancing on axis 1).</p>
</dd>
</dl>
</section>
<section id="numpy_concatenate_split" class="level3">
<h3 class="anchored" data-anchor-id="numpy_concatenate_split">Concatenating and Splitting Arrays</h3>
<p><code>numpy.concatenate</code> takes a sequence (tuple, list, etc.) of arrays and joins them in order along the input axis:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">37</span>]: arr1 <span class="op">=</span> np.array([[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]])</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">38</span>]: arr2 <span class="op">=</span> np.array([[<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>], [<span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>]])</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">39</span>]: np.concatenate([arr1, arr2], axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">39</span>]: </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">3</span>],</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">4</span>,  <span class="dv">5</span>,  <span class="dv">6</span>],</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">7</span>,  <span class="dv">8</span>,  <span class="dv">9</span>],</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>]])</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">40</span>]: np.concatenate([arr1, arr2], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">40</span>]: </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">3</span>,  <span class="dv">7</span>,  <span class="dv">8</span>,  <span class="dv">9</span>],</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">4</span>,  <span class="dv">5</span>,  <span class="dv">6</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are some convenience functions, like <code>vstack</code> and <code>hstack</code>, for common kinds of concatenation. The preceding operations could have been expressed as:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">41</span>]: np.vstack((arr1, arr2))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">41</span>]: </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">3</span>],</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">4</span>,  <span class="dv">5</span>,  <span class="dv">6</span>],</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">7</span>,  <span class="dv">8</span>,  <span class="dv">9</span>],</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>]])</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">42</span>]: np.hstack((arr1, arr2))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">42</span>]: </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">3</span>,  <span class="dv">7</span>,  <span class="dv">8</span>,  <span class="dv">9</span>],</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">4</span>,  <span class="dv">5</span>,  <span class="dv">6</span>, <span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>split</code>, on the other hand, slices an array into multiple arrays along an axis:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">43</span>]: arr <span class="op">=</span> rng.standard_normal((<span class="dv">5</span>, <span class="dv">2</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">44</span>]: arr</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">44</span>]: </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>array([[<span class="op">-</span><span class="fl">1.4238</span>,  <span class="fl">1.2637</span>],</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.8707</span>, <span class="op">-</span><span class="fl">0.2592</span>],</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.0753</span>, <span class="op">-</span><span class="fl">0.7409</span>],</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">1.3678</span>,  <span class="fl">0.6489</span>],</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.3611</span>, <span class="op">-</span><span class="fl">1.9529</span>]])</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">45</span>]: first, second, third <span class="op">=</span> np.split(arr, [<span class="dv">1</span>, <span class="dv">3</span>])</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">46</span>]: first</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">46</span>]: array([[<span class="op">-</span><span class="fl">1.4238</span>,  <span class="fl">1.2637</span>]])</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">47</span>]: second</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">47</span>]: </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>array([[<span class="op">-</span><span class="fl">0.8707</span>, <span class="op">-</span><span class="fl">0.2592</span>],</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.0753</span>, <span class="op">-</span><span class="fl">0.7409</span>]])</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">48</span>]: third</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">48</span>]: </span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>array([[<span class="op">-</span><span class="fl">1.3678</span>,  <span class="fl">0.6489</span>],</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.3611</span>, <span class="op">-</span><span class="fl">1.9529</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The value <code>[1, 3]</code> passed to <code>np.split</code> indicates the indices at which to split the array into pieces.</p>
<p>See <a href="#tbl-table_array_concatenating">Table&nbsp;<span>A.1</span></a> for a list of all relevant concatenation and splitting functions, some of which are provided only as a convenience of the very general-purpose <code>concatenate</code>.</p>
<div id="tbl-table_array_concatenating" class="anchored">
<table class="table">
<caption>Table&nbsp;A.1: Array concatenation functions</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Function</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>concatenate</code></td>
<td style="text-align: left;">Most general function, concatenate collection of arrays along one axis</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>vstack, row_stack</code></td>
<td style="text-align: left;">Stack arrays by rows (along axis 0)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>hstack</code></td>
<td style="text-align: left;">Stack arrays by columns (along axis 1)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>column_stack</code></td>
<td style="text-align: left;">Like <code>hstack</code>, but convert 1D arrays to 2D column vectors first</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>dstack</code></td>
<td style="text-align: left;">Stack arrays by “depth” (along axis 2)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>split</code></td>
<td style="text-align: left;">Split array at passed locations along a particular axis</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>hsplit</code>/<code>vsplit</code></td>
<td style="text-align: left;">Convenience functions for splitting on axis 0 and 1, respectively</td>
</tr>
</tbody>
</table>
</div>
<section id="numpy_concat_index_tricks" class="level4">
<h4 class="anchored" data-anchor-id="numpy_concat_index_tricks">Stacking helpers: r_ and c_</h4>
<p>There are two special objects in the NumPy namespace, <code>r_</code> and <code>c_</code>, that make stacking arrays more concise:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">49</span>]: arr <span class="op">=</span> np.arange(<span class="dv">6</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">50</span>]: arr1 <span class="op">=</span> arr.reshape((<span class="dv">3</span>, <span class="dv">2</span>))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">51</span>]: arr2 <span class="op">=</span> rng.standard_normal((<span class="dv">3</span>, <span class="dv">2</span>))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">52</span>]: np.r_[arr1, arr2]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">52</span>]: </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.</span>    ,  <span class="fl">1.</span>    ],</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">2.</span>    ,  <span class="fl">3.</span>    ],</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">4.</span>    ,  <span class="fl">5.</span>    ],</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">2.3474</span>,  <span class="fl">0.9685</span>],</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.7594</span>,  <span class="fl">0.9022</span>],</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.467</span> , <span class="op">-</span><span class="fl">0.0607</span>]])</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">53</span>]: np.c_[np.r_[arr1, arr2], arr]</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">53</span>]: </span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.</span>    ,  <span class="fl">1.</span>    ,  <span class="fl">0.</span>    ],</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">2.</span>    ,  <span class="fl">3.</span>    ,  <span class="fl">1.</span>    ],</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">4.</span>    ,  <span class="fl">5.</span>    ,  <span class="fl">2.</span>    ],</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">2.3474</span>,  <span class="fl">0.9685</span>,  <span class="fl">3.</span>    ],</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.7594</span>,  <span class="fl">0.9022</span>,  <span class="fl">4.</span>    ],</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.467</span> , <span class="op">-</span><span class="fl">0.0607</span>,  <span class="fl">5.</span>    ]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These additionally can translate slices to arrays:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">54</span>]: np.c_[<span class="dv">1</span>:<span class="dv">6</span>, <span class="op">-</span><span class="dv">10</span>:<span class="op">-</span><span class="dv">5</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">54</span>]: </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>array([[  <span class="dv">1</span>, <span class="op">-</span><span class="dv">10</span>],</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>       [  <span class="dv">2</span>,  <span class="op">-</span><span class="dv">9</span>],</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>       [  <span class="dv">3</span>,  <span class="op">-</span><span class="dv">8</span>],</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>       [  <span class="dv">4</span>,  <span class="op">-</span><span class="dv">7</span>],</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>       [  <span class="dv">5</span>,  <span class="op">-</span><span class="dv">6</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>See the docstring for more on what you can do with <code>c_</code> and <code>r_</code>.</p>
</section>
</section>
<section id="numpy_tile_repeat" class="level3">
<h3 class="anchored" data-anchor-id="numpy_tile_repeat">Repeating Elements: tile and repeat</h3>
<p>Two useful tools for repeating or replicating arrays to produce larger arrays are the <code>repeat</code> and <code>tile</code> functions. <code>repeat</code> replicates each element in an array some number of times, producing a larger array:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">55</span>]: arr <span class="op">=</span> np.arange(<span class="dv">3</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">56</span>]: arr</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">56</span>]: array([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">57</span>]: arr.repeat(<span class="dv">3</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">57</span>]: array([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The need to replicate or repeat arrays can be less common with NumPy than it is with other array programming frameworks like MATLAB. One reason for this is that <em>broadcasting</em> often fills this need better, which is the subject of the next section.</p>
</div>
</div>
<p>By default, if you pass an integer, each element will be repeated that number of times. If you pass an array of integers, each element can be repeated a different number of times:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">58</span>]: arr.repeat([<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>])</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">58</span>]: array([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Multidimensional arrays can have their elements repeated along a particular axis:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">59</span>]: arr <span class="op">=</span> rng.standard_normal((<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">60</span>]: arr</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">60</span>]: </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ]])</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">61</span>]: arr.repeat(<span class="dv">2</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">61</span>]: </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ],</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that if no axis is passed, the array will be flattened first, which is likely not what you want. Similarly, you can pass an array of integers when repeating a multidimensional array to repeat a given slice a different number of times:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">62</span>]: arr.repeat([<span class="dv">2</span>, <span class="dv">3</span>], axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">62</span>]: </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ],</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ],</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ]])</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">63</span>]: arr.repeat([<span class="dv">2</span>, <span class="dv">3</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">63</span>]: </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.7888</span>,  <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>, <span class="op">-</span><span class="fl">1.2567</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ,  <span class="fl">1.399</span> ,  <span class="fl">1.399</span> ]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>tile</code>, on the other hand, is a shortcut for stacking copies of an array along an axis. Visually you can think of it as being akin to “laying down tiles”:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">64</span>]: arr</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">64</span>]: </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ]])</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">65</span>]: np.tile(arr, <span class="dv">2</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">65</span>]: </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>,  <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ,  <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The second argument is the number of tiles; with a scalar, the tiling is made row by row, rather than column by column. The second argument to <code>tile</code> can be a tuple indicating the layout of the “tiling”:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">66</span>]: arr</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">66</span>]: </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ]])</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">67</span>]: np.tile(arr, (<span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">67</span>]: </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ],</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ]])</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">68</span>]: np.tile(arr, (<span class="dv">3</span>, <span class="dv">2</span>))</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">68</span>]: </span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>,  <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ,  <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ],</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>,  <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ,  <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ],</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>,  <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>],</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ,  <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="numpy_indexing_apis" class="level3">
<h3 class="anchored" data-anchor-id="numpy_indexing_apis">Fancy Indexing Equivalents: take and put</h3>
<p>As you may recall from <a href='/book/numpy-basics'>Ch 4: NumPy Basics: Arrays and Vectorized Computation</a>, one way to get and set subsets of arrays is by <em>fancy</em> indexing using integer arrays:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">69</span>]: arr <span class="op">=</span> np.arange(<span class="dv">10</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">70</span>]: inds <span class="op">=</span> [<span class="dv">7</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">6</span>]</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">71</span>]: arr[inds]</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">71</span>]: array([<span class="dv">700</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">600</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are alternative ndarray methods that are useful in the special case of making a selection only on a single axis:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">72</span>]: arr.take(inds)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">72</span>]: array([<span class="dv">700</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">600</span>])</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">73</span>]: arr.put(inds, <span class="dv">42</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">74</span>]: arr</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">74</span>]: array([  <span class="dv">0</span>,  <span class="dv">42</span>,  <span class="dv">42</span>, <span class="dv">300</span>, <span class="dv">400</span>, <span class="dv">500</span>,  <span class="dv">42</span>,  <span class="dv">42</span>, <span class="dv">800</span>, <span class="dv">900</span>])</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">75</span>]: arr.put(inds, [<span class="dv">40</span>, <span class="dv">41</span>, <span class="dv">42</span>, <span class="dv">43</span>])</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">76</span>]: arr</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">76</span>]: array([  <span class="dv">0</span>,  <span class="dv">41</span>,  <span class="dv">42</span>, <span class="dv">300</span>, <span class="dv">400</span>, <span class="dv">500</span>,  <span class="dv">43</span>,  <span class="dv">40</span>, <span class="dv">800</span>, <span class="dv">900</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To use <code>take</code> along other axes, you can pass the <code>axis</code> keyword:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">77</span>]: inds <span class="op">=</span> [<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">78</span>]: arr <span class="op">=</span> rng.standard_normal((<span class="dv">2</span>, <span class="dv">4</span>))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">79</span>]: arr</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">79</span>]: </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">1.3223</span>, <span class="op">-</span><span class="fl">0.2997</span>,  <span class="fl">0.9029</span>, <span class="op">-</span><span class="fl">1.6216</span>],</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.1582</span>,  <span class="fl">0.4495</span>, <span class="op">-</span><span class="fl">1.3436</span>, <span class="op">-</span><span class="fl">0.0817</span>]])</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">80</span>]: arr.take(inds, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">80</span>]: </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.9029</span>,  <span class="fl">1.3223</span>,  <span class="fl">0.9029</span>, <span class="op">-</span><span class="fl">0.2997</span>],</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">1.3436</span>, <span class="op">-</span><span class="fl">0.1582</span>, <span class="op">-</span><span class="fl">1.3436</span>,  <span class="fl">0.4495</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>put</code> does not accept an <code>axis</code> argument but rather indexes into the flattened (one-dimensional, C order) version of the array. Thus, when you need to set elements using an index array on other axes, it is best to use <code>[]</code>-based indexing.</p>
</section>
</section>
<section id="numpy_broadcasting" class="level2" data-number="A.3">
<h2 data-number="A.3" class="anchored" data-anchor-id="numpy_broadcasting"><span class="header-section-number">A.3</span> Broadcasting</h2>
<p><em>Broadcasting</em> governs how operations work between arrays of different shapes. It can be a powerful feature, but it can cause confusion, even for experienced users. The simplest example of broadcasting occurs when combining a scalar value with an array:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">81</span>]: arr <span class="op">=</span> np.arange(<span class="dv">5</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">82</span>]: arr</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">82</span>]: array([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>])</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">83</span>]: arr <span class="op">*</span> <span class="dv">4</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">83</span>]: array([ <span class="dv">0</span>,  <span class="dv">4</span>,  <span class="dv">8</span>, <span class="dv">12</span>, <span class="dv">16</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here we say that the scalar value 4 has been <em>broadcast</em> to all of the other elements in the multiplication operation.</p>
<p>For example, we can demean each column of an array by subtracting the column means. In this case, it is necessary only to subtract an array containing the mean of each column:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">84</span>]: arr <span class="op">=</span> rng.standard_normal((<span class="dv">4</span>, <span class="dv">3</span>))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">85</span>]: arr.mean(<span class="dv">0</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">85</span>]: array([<span class="fl">0.1206</span>, <span class="fl">0.243</span> , <span class="fl">0.1444</span>])</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">86</span>]: demeaned <span class="op">=</span> arr <span class="op">-</span> arr.mean(<span class="dv">0</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">87</span>]: demeaned</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">87</span>]: </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">1.6042</span>,  <span class="fl">2.3751</span>,  <span class="fl">0.633</span> ],</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.7081</span>, <span class="op">-</span><span class="fl">1.202</span> , <span class="op">-</span><span class="fl">1.3538</span>],</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">1.5329</span>,  <span class="fl">0.2985</span>,  <span class="fl">0.6076</span>],</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.7793</span>, <span class="op">-</span><span class="fl">1.4717</span>,  <span class="fl">0.1132</span>]])</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">88</span>]: demeaned.mean(<span class="dv">0</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">88</span>]: array([ <span class="fl">0.</span>, <span class="op">-</span><span class="fl">0.</span>,  <span class="fl">0.</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>See <a href="#fig-figure_broadcasting1">Figure&nbsp;<span>A.4</span></a> for an illustration of this operation. Demeaning the rows as a broadcast operation requires a bit more care. Fortunately, broadcasting potentially lower dimensional values across any dimension of an array (like subtracting the row means from each column of a two-dimensional array) is possible as long as you follow the rules.</p>
<p>This brings us to the broadcasting rule.</p>
<p>Two arrays are compatible for broadcasting if for each <em>trailing dimension</em> (i.e., starting from the end) the axis lengths match or if either of the lengths is 1. Broadcasting is then performed over the missing or length 1 dimensions.</p>
<div id="fig-figure_broadcasting1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/pda3_a004.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;A.4: Broadcasting over axis 0 with a 1D array</figcaption>
</figure>
</div>
<p>Even as an experienced NumPy user, I often find myself having to pause and draw a diagram as I think about the broadcasting rule. Consider the last example and suppose we wished instead to subtract the mean value from each row. Since <code>arr.mean(0)</code> has length 3, it is compatible for broadcasting across axis 0 because the trailing dimension in <code>arr</code> is 3 and therefore matches. According to the rules, to subtract over axis 1 (i.e., subtract the row mean from each row), the smaller array must have the shape <code>(4, 1)</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">89</span>]: arr</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">89</span>]: </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">1.7247</span>,  <span class="fl">2.6182</span>,  <span class="fl">0.7774</span>],</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.8286</span>, <span class="op">-</span><span class="fl">0.959</span> , <span class="op">-</span><span class="fl">1.2094</span>],</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">1.4123</span>,  <span class="fl">0.5415</span>,  <span class="fl">0.7519</span>],</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.6588</span>, <span class="op">-</span><span class="fl">1.2287</span>,  <span class="fl">0.2576</span>]])</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">90</span>]: row_means <span class="op">=</span> arr.mean(<span class="dv">1</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">91</span>]: row_means.shape</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">91</span>]: (<span class="dv">4</span>,)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">92</span>]: row_means.reshape((<span class="dv">4</span>, <span class="dv">1</span>))</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">92</span>]: </span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">1.7068</span>],</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.4466</span>],</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.0396</span>],</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.5433</span>]])</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">93</span>]: demeaned <span class="op">=</span> arr <span class="op">-</span> row_means.reshape((<span class="dv">4</span>, <span class="dv">1</span>))</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">94</span>]: demeaned.mean(<span class="dv">1</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">94</span>]: array([<span class="op">-</span><span class="fl">0.</span>,  <span class="fl">0.</span>,  <span class="fl">0.</span>,  <span class="fl">0.</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>See <a href="#fig-figure_broadcasting2">Figure&nbsp;<span>A.5</span></a> for an illustration of this operation.</p>
<div id="fig-figure_broadcasting2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/pda3_a005.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;A.5: Broadcasting over axis 1 of a 2D array</figcaption>
</figure>
</div>
<p>See <a href="#fig-figure_broadcasting3">Figure&nbsp;<span>A.6</span></a> for another illustration, this time adding a two-dimensional array to a three-dimensional one across axis 0.</p>
<div id="fig-figure_broadcasting3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/pda3_a006.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;A.6: Broadcasting over axis 0 of a 3D array</figcaption>
</figure>
</div>
<section id="broadcasting_length1" class="level3">
<h3 class="anchored" data-anchor-id="broadcasting_length1">Broadcasting over Other Axes</h3>
<p>Broadcasting with higher dimensional arrays can seem even more mind-bending, but it is really a matter of following the rules. If you don’t, you’ll get an error like this:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">95</span>]: arr <span class="op">-</span> arr.mean(<span class="dv">1</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="op">---------------------------------------------------------------------------</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="pp">ValueError</span>                                Traceback (most recent call last)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>ipython<span class="op">-</span><span class="bu">input</span><span class="op">-</span><span class="dv">95</span><span class="op">-</span><span class="dv">8</span><span class="er">b8ada26fac0</span><span class="op">&gt;</span> <span class="kw">in</span> <span class="op">&lt;</span>module<span class="op">&gt;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="op">----&gt;</span> <span class="dv">1</span> arr <span class="op">-</span> arr.mean(<span class="dv">1</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="pp">ValueError</span>: operands could <span class="kw">not</span> be broadcast together <span class="cf">with</span> shapes (<span class="dv">4</span>,<span class="dv">3</span>) (<span class="dv">4</span>,) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It’s quite common to want to perform an arithmetic operation with a lower dimensional array across axes other than axis 0. According to the broadcasting rule, the “broadcast dimensions” must be 1 in the smaller array. In the example of row demeaning shown here, this means reshaping the row to be shape <code>(4, 1)</code> instead of <code>(4,)</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">96</span>]: arr <span class="op">-</span> arr.mean(<span class="dv">1</span>).reshape((<span class="dv">4</span>, <span class="dv">1</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">96</span>]: </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.018</span> ,  <span class="fl">0.9114</span>, <span class="op">-</span><span class="fl">0.9294</span>],</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">1.2752</span>, <span class="op">-</span><span class="fl">0.5124</span>, <span class="op">-</span><span class="fl">0.7628</span>],</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">1.3727</span>,  <span class="fl">0.5811</span>,  <span class="fl">0.7915</span>],</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.1155</span>, <span class="op">-</span><span class="fl">0.6854</span>,  <span class="fl">0.8009</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In the three-dimensional case, broadcasting over any of the three dimensions is only a matter of reshaping the data to be shape compatible. <a href="#fig-figure_broadcasting_3d">Figure&nbsp;<span>A.7</span></a> nicely visualizes the shapes required to broadcast over each axis of a three-dimensional array.</p>
<div id="fig-figure_broadcasting_3d" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/pda3_a007.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;A.7: Compatible 2D array shapes for broadcasting over a 3D array</figcaption>
</figure>
</div>
<p>A common problem, therefore, is needing to add a new axis with length 1 specifically for broadcasting purposes. Using <code>reshape</code> is one option, but inserting an axis requires constructing a tuple indicating the new shape. This often can be a tedious exercise. Thus, NumPy arrays offer a special syntax for inserting new axes by indexing. We use the special <code>np.newaxis</code> attribute along with “full” slices to insert the new axis:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">97</span>]: arr <span class="op">=</span> np.zeros((<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">98</span>]: arr_3d <span class="op">=</span> arr[:, np.newaxis, :]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">99</span>]: arr_3d.shape</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">99</span>]: (<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">100</span>]: arr_1d <span class="op">=</span> rng.standard_normal(<span class="dv">3</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">101</span>]: arr_1d[:, np.newaxis]</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">101</span>]: </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.3129</span>],</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.1308</span>],</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">1.27</span>  ]])</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">102</span>]: arr_1d[np.newaxis, :]</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">102</span>]: array([[ <span class="fl">0.3129</span>, <span class="op">-</span><span class="fl">0.1308</span>,  <span class="fl">1.27</span>  ]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Thus, if we had a three-dimensional array and wanted to demean axis 2, we would need to write:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">103</span>]: arr <span class="op">=</span> rng.standard_normal((<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">104</span>]: depth_means <span class="op">=</span> arr.mean(<span class="dv">2</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">105</span>]: depth_means</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">105</span>]: </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.0431</span>,  <span class="fl">0.2747</span>, <span class="op">-</span><span class="fl">0.1885</span>, <span class="op">-</span><span class="fl">0.2014</span>],</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.5732</span>, <span class="op">-</span><span class="fl">0.5467</span>,  <span class="fl">0.1183</span>, <span class="op">-</span><span class="fl">0.6301</span>],</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.0972</span>,  <span class="fl">0.5954</span>,  <span class="fl">0.0331</span>, <span class="op">-</span><span class="fl">0.6002</span>]])</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">106</span>]: depth_means.shape</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">106</span>]: (<span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">107</span>]: demeaned <span class="op">=</span> arr <span class="op">-</span> depth_means[:, :, np.newaxis]</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">108</span>]: demeaned.mean(<span class="dv">2</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">108</span>]: </span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.</span>, <span class="op">-</span><span class="fl">0.</span>,  <span class="fl">0.</span>, <span class="op">-</span><span class="fl">0.</span>],</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.</span>, <span class="op">-</span><span class="fl">0.</span>, <span class="op">-</span><span class="fl">0.</span>, <span class="op">-</span><span class="fl">0.</span>],</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.</span>,  <span class="fl">0.</span>,  <span class="fl">0.</span>,  <span class="fl">0.</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You might be wondering if there’s a way to generalize demeaning over an axis without sacrificing performance. There is, but it requires some indexing gymnastics:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> demean_axis(arr, axis<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> arr.mean(axis)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This generalizes things like [:, :, np.newaxis] to N dimensions</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    indexer <span class="op">=</span> [<span class="bu">slice</span>(<span class="va">None</span>)] <span class="op">*</span> arr.ndim</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    indexer[axis] <span class="op">=</span> np.newaxis</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arr <span class="op">-</span> means[indexer]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="numpy_broadcasting_setting" class="level3">
<h3 class="anchored" data-anchor-id="numpy_broadcasting_setting">Setting Array Values by Broadcasting</h3>
<p>The same broadcasting rule governing arithmetic operations also applies to setting values via array indexing. In a simple case, we can do things like:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">109</span>]: arr <span class="op">=</span> np.zeros((<span class="dv">4</span>, <span class="dv">3</span>))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">110</span>]: arr[:] <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">111</span>]: arr</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">111</span>]: </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>array([[<span class="fl">5.</span>, <span class="fl">5.</span>, <span class="fl">5.</span>],</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>       [<span class="fl">5.</span>, <span class="fl">5.</span>, <span class="fl">5.</span>],</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>       [<span class="fl">5.</span>, <span class="fl">5.</span>, <span class="fl">5.</span>],</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>       [<span class="fl">5.</span>, <span class="fl">5.</span>, <span class="fl">5.</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, if we had a one-dimensional array of values we wanted to set into the columns of the array, we can do that as long as the shape is compatible:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">112</span>]: col <span class="op">=</span> np.array([<span class="fl">1.28</span>, <span class="op">-</span><span class="fl">0.42</span>, <span class="fl">0.44</span>, <span class="fl">1.6</span>])</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">113</span>]: arr[:] <span class="op">=</span> col[:, np.newaxis]</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">114</span>]: arr</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">114</span>]: </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">1.28</span>,  <span class="fl">1.28</span>,  <span class="fl">1.28</span>],</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.42</span>, <span class="op">-</span><span class="fl">0.42</span>, <span class="op">-</span><span class="fl">0.42</span>],</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.44</span>,  <span class="fl">0.44</span>,  <span class="fl">0.44</span>],</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">1.6</span> ,  <span class="fl">1.6</span> ,  <span class="fl">1.6</span> ]])</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">115</span>]: arr[:<span class="dv">2</span>] <span class="op">=</span> [[<span class="op">-</span><span class="fl">1.37</span>], [<span class="fl">0.509</span>]]</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">116</span>]: arr</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">116</span>]: </span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>array([[<span class="op">-</span><span class="fl">1.37</span> , <span class="op">-</span><span class="fl">1.37</span> , <span class="op">-</span><span class="fl">1.37</span> ],</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.509</span>,  <span class="fl">0.509</span>,  <span class="fl">0.509</span>],</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.44</span> ,  <span class="fl">0.44</span> ,  <span class="fl">0.44</span> ],</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">1.6</span>  ,  <span class="fl">1.6</span>  ,  <span class="fl">1.6</span>  ]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="ufunc_advanced" class="level2" data-number="A.4">
<h2 data-number="A.4" class="anchored" data-anchor-id="ufunc_advanced"><span class="header-section-number">A.4</span> Advanced ufunc Usage</h2>
<p>While many NumPy users will only use the fast element-wise operations provided by the universal functions, a number of additional features occasionally can help you write more concise code without explicit loops.</p>
<section id="ufunc_methods" class="level3">
<h3 class="anchored" data-anchor-id="ufunc_methods">ufunc Instance Methods</h3>
<p>Each of NumPy’s binary ufuncs has special methods for performing certain kinds of special vectorized operations. These are summarized in <a href="#tbl-table_ufunc_methods">Table&nbsp;<span>A.2</span></a>, but I’ll give a few concrete examples to illustrate how they work.</p>
<p><code>reduce</code> takes a single array and aggregates its values, optionally along an axis, by performing a sequence of binary operations. For example, an alternative way to sum elements in an array is to use <code>np.add.reduce</code>:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">117</span>]: arr <span class="op">=</span> np.arange(<span class="dv">10</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">118</span>]: np.add.<span class="bu">reduce</span>(arr)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">118</span>]: <span class="dv">45</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">119</span>]: arr.<span class="bu">sum</span>()</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">119</span>]: <span class="dv">45</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The starting value (for example, 0 for <code>add</code>) depends on the ufunc. If an axis is passed, the reduction is performed along that axis. This allows you to answer certain kinds of questions in a concise way. As a less mundane example, we can use <code>np.logical_and</code> to check whether the values in each row of an array are sorted:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">120</span>]: my_rng <span class="op">=</span> np.random.default_rng(<span class="dv">12346</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">121</span>]: arr <span class="op">=</span> my_rng.standard_normal((<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">122</span>]: arr</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">122</span>]: </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>array([[<span class="op">-</span><span class="fl">0.9039</span>,  <span class="fl">0.1571</span>,  <span class="fl">0.8976</span>, <span class="op">-</span><span class="fl">0.7622</span>, <span class="op">-</span><span class="fl">0.1763</span>],</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.053</span> , <span class="op">-</span><span class="fl">1.6284</span>, <span class="op">-</span><span class="fl">0.1775</span>,  <span class="fl">1.9636</span>,  <span class="fl">1.7813</span>],</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.8797</span>, <span class="op">-</span><span class="fl">1.6985</span>, <span class="op">-</span><span class="fl">1.8189</span>,  <span class="fl">0.119</span> , <span class="op">-</span><span class="fl">0.4441</span>],</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.7691</span>, <span class="op">-</span><span class="fl">0.0343</span>,  <span class="fl">0.3925</span>,  <span class="fl">0.7589</span>, <span class="op">-</span><span class="fl">0.0705</span>],</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">1.0498</span>,  <span class="fl">1.0297</span>, <span class="op">-</span><span class="fl">0.4201</span>,  <span class="fl">0.7863</span>,  <span class="fl">0.9612</span>]])</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">123</span>]: arr[::<span class="dv">2</span>].sort(<span class="dv">1</span>) <span class="co"># sort a few rows</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">124</span>]: arr[:, :<span class="op">-</span><span class="dv">1</span>] <span class="op">&lt;</span> arr[:, <span class="dv">1</span>:]</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">124</span>]: </span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>array([[ <span class="va">True</span>,  <span class="va">True</span>,  <span class="va">True</span>,  <span class="va">True</span>],</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>       [<span class="va">False</span>,  <span class="va">True</span>,  <span class="va">True</span>, <span class="va">False</span>],</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>       [ <span class="va">True</span>,  <span class="va">True</span>,  <span class="va">True</span>,  <span class="va">True</span>],</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>       [<span class="va">False</span>,  <span class="va">True</span>,  <span class="va">True</span>, <span class="va">False</span>],</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>       [ <span class="va">True</span>,  <span class="va">True</span>,  <span class="va">True</span>,  <span class="va">True</span>]])</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">125</span>]: np.logical_and.<span class="bu">reduce</span>(arr[:, :<span class="op">-</span><span class="dv">1</span>] <span class="op">&lt;</span> arr[:, <span class="dv">1</span>:], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">125</span>]: array([ <span class="va">True</span>, <span class="va">False</span>,  <span class="va">True</span>, <span class="va">False</span>,  <span class="va">True</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that <code>logical_and.reduce</code> is equivalent to the <code>all</code> method.</p>
<p>The <code>accumulate</code> ufunc method is related to <code>reduce</code>, like <code>cumsum</code> is related to <code>sum</code>. It produces an array of the same size with the intermediate “accumulated” values:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">126</span>]: arr <span class="op">=</span> np.arange(<span class="dv">15</span>).reshape((<span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">127</span>]: np.add.accumulate(arr, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">127</span>]: </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">3</span>,  <span class="dv">6</span>, <span class="dv">10</span>],</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">5</span>, <span class="dv">11</span>, <span class="dv">18</span>, <span class="dv">26</span>, <span class="dv">35</span>],</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">10</span>, <span class="dv">21</span>, <span class="dv">33</span>, <span class="dv">46</span>, <span class="dv">60</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>outer</code> performs a pair-wise cross product between two arrays:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">128</span>]: arr <span class="op">=</span> np.arange(<span class="dv">3</span>).repeat([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>])</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">129</span>]: arr</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">129</span>]: array([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>])</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">130</span>]: np.multiply.outer(arr, np.arange(<span class="dv">5</span>))</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">130</span>]: </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>array([[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>],</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>],</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>],</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output of <code>outer</code> will have a dimension that is the concatenation of the dimensions of the inputs:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">131</span>]: x, y <span class="op">=</span> rng.standard_normal((<span class="dv">3</span>, <span class="dv">4</span>)), rng.standard_normal(<span class="dv">5</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">132</span>]: result <span class="op">=</span> np.subtract.outer(x, y)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">133</span>]: result.shape</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">133</span>]: (<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The last method, <code>reduceat</code>, performs a “local reduce,” in essence an array “group by” operation in which slices of the array are aggregated together. It accepts a sequence of “bin edges” that indicate how to split and aggregate the values:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">134</span>]: arr <span class="op">=</span> np.arange(<span class="dv">10</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">135</span>]: np.add.reduceat(arr, [<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">8</span>])</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">135</span>]: array([<span class="dv">10</span>, <span class="dv">18</span>, <span class="dv">17</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The results are the reductions (here, sums) performed over <code>arr[0:5]</code>, <code>arr[5:8]</code>, and <code>arr[8:]</code>. As with the other methods, you can pass an <code>axis</code> argument:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">136</span>]: arr <span class="op">=</span> np.multiply.outer(np.arange(<span class="dv">4</span>), np.arange(<span class="dv">5</span>))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">137</span>]: arr</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">137</span>]: </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">0</span>,  <span class="dv">0</span>,  <span class="dv">0</span>,  <span class="dv">0</span>,  <span class="dv">0</span>],</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">3</span>,  <span class="dv">4</span>],</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">0</span>,  <span class="dv">2</span>,  <span class="dv">4</span>,  <span class="dv">6</span>,  <span class="dv">8</span>],</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">0</span>,  <span class="dv">3</span>,  <span class="dv">6</span>,  <span class="dv">9</span>, <span class="dv">12</span>]])</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">138</span>]: np.add.reduceat(arr, [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">138</span>]: </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>array([[ <span class="dv">0</span>,  <span class="dv">0</span>,  <span class="dv">0</span>],</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">1</span>,  <span class="dv">5</span>,  <span class="dv">4</span>],</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">2</span>, <span class="dv">10</span>,  <span class="dv">8</span>],</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>       [ <span class="dv">3</span>, <span class="dv">15</span>, <span class="dv">12</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>See <a href="#tbl-table_ufunc_methods">Table&nbsp;<span>A.2</span></a> for a partial listing of ufunc methods.</p>
<div id="tbl-table_ufunc_methods" class="anchored">
<table class="table">
<caption>Table&nbsp;A.2: ufunc methods</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Method</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>accumulate(x)</code></td>
<td style="text-align: left;">Aggregate values, preserving all partial aggregates.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>at(x, indices, b=None)</code></td>
<td style="text-align: left;">Perform operation in place on <code>x</code> at the specified indices. The argument <code>b</code> is the second input to ufuncs that requires two array inputs.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>reduce(x)</code></td>
<td style="text-align: left;">Aggregate values by successive applications of the operation.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>reduceat(x, bins)</code></td>
<td style="text-align: left;">“Local” reduce or “group by”; reduce contiguous slices of data to produce an aggregated array.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>outer(x, y)</code></td>
<td style="text-align: left;">Apply operation to all pairs of elements in <code>x</code> and <code>y</code>; the resulting array has shape <code>x.shape + y.shape</code>.</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="ufunc_custom" class="level3">
<h3 class="anchored" data-anchor-id="ufunc_custom">Writing New ufuncs in Python</h3>
<p>There are a number of ways to create your own NumPy ufuncs. The most general is to use the NumPy C API, but that is beyond the scope of this book. In this section, we will look at pure Python ufuncs.</p>
<p><code>numpy.frompyfunc</code> accepts a Python function along with a specification for the number of inputs and outputs. For example, a simple function that adds element-wise would be specified as:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">139</span>]: <span class="kw">def</span> add_elements(x, y):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>   .....:     <span class="cf">return</span> x <span class="op">+</span> y</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">140</span>]: add_them <span class="op">=</span> np.frompyfunc(add_elements, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">141</span>]: add_them(np.arange(<span class="dv">8</span>), np.arange(<span class="dv">8</span>))</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">141</span>]: array([<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">14</span>], dtype<span class="op">=</span><span class="bu">object</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Functions created using <code>frompyfunc</code> always return arrays of Python objects, which can be inconvenient. Fortunately, there is an alternative (but slightly less feature rich) function, <code>numpy.vectorize</code>, that allows you to specify the output type:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">142</span>]: add_them <span class="op">=</span> np.vectorize(add_elements, otypes<span class="op">=</span>[np.float64])</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">143</span>]: add_them(np.arange(<span class="dv">8</span>), np.arange(<span class="dv">8</span>))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">143</span>]: array([ <span class="fl">0.</span>,  <span class="fl">2.</span>,  <span class="fl">4.</span>,  <span class="fl">6.</span>,  <span class="fl">8.</span>, <span class="fl">10.</span>, <span class="fl">12.</span>, <span class="fl">14.</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These functions provide a way to create ufunc-like functions, but they are very slow because they require a Python function call to compute each element, which is a lot slower than NumPy’s C-based ufunc loops:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">144</span>]: arr <span class="op">=</span> rng.standard_normal(<span class="dv">10000</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">145</span>]: <span class="op">%</span>timeit add_them(arr, arr)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fl">1.18</span> ms <span class="op">+-</span> <span class="fl">14.8</span> us per loop (mean <span class="op">+-</span> std. dev. of <span class="dv">7</span> runs, <span class="dv">1000</span> loops each)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">146</span>]: <span class="op">%</span>timeit np.add(arr, arr)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="fl">2.8</span> us <span class="op">+-</span> <span class="fl">64.1</span> ns per loop (mean <span class="op">+-</span> std. dev. of <span class="dv">7</span> runs, <span class="dv">100000</span> loops each)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Later in this appendix we'll show how to create fast ufuncs in Python using the <a href="http://numba.pydata.org">Numba library</a>.</p>
</section>
</section>
<section id="numpy_structured" class="level2" data-number="A.5">
<h2 data-number="A.5" class="anchored" data-anchor-id="numpy_structured"><span class="header-section-number">A.5</span> Structured and Record Arrays</h2>
<p>You may have noticed up until now that ndarray is a <em>homogeneous</em> data container; that is, it represents a block of memory in which each element takes up the same number of bytes, as determined by the data type. On the surface, this would appear to not allow you to represent heterogeneous or tabular data. A <em>structured</em> array is an ndarray in which each element can be thought of as representing a <em>struct</em> in C (hence the “structured” name) or a row in a SQL table with multiple named fields:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">147</span>]: dtype <span class="op">=</span> [(<span class="st">'x'</span>, np.float64), (<span class="st">'y'</span>, np.int32)]</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">148</span>]: sarr <span class="op">=</span> np.array([(<span class="fl">1.5</span>, <span class="dv">6</span>), (np.pi, <span class="op">-</span><span class="dv">2</span>)], dtype<span class="op">=</span>dtype)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">149</span>]: sarr</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">149</span>]: array([(<span class="fl">1.5</span>   ,  <span class="dv">6</span>), (<span class="fl">3.1416</span>, <span class="op">-</span><span class="dv">2</span>)], dtype<span class="op">=</span>[(<span class="st">'x'</span>, <span class="st">'&lt;f8'</span>), (<span class="st">'y'</span>, <span class="st">'&lt;i4'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are several ways to specify a structured data type (see the online NumPy documentation). One typical way is as a list of tuples with <code>(field_name, field_data_type)</code>. Now, the elements of the array are tuple-like objects whose elements can be accessed like a dictionary:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">150</span>]: sarr[<span class="dv">0</span>]</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">150</span>]: (<span class="fl">1.5</span>, <span class="dv">6</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">151</span>]: sarr[<span class="dv">0</span>][<span class="st">'y'</span>]</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">151</span>]: <span class="dv">6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The field names are stored in the <code>dtype.names</code> attribute. When you access a field on the structured array, a strided view on the data is returned, thus copying nothing:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">152</span>]: sarr[<span class="st">'x'</span>]</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">152</span>]: array([<span class="fl">1.5</span>   , <span class="fl">3.1416</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="numpy_structured_nested_varlength" class="level3">
<h3 class="anchored" data-anchor-id="numpy_structured_nested_varlength">Nested Data Types and Multidimensional Fields</h3>
<p>When specifying a structured data type, you can additionally pass a shape (as an int or tuple):</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">153</span>]: dtype <span class="op">=</span> [(<span class="st">'x'</span>, np.int64, <span class="dv">3</span>), (<span class="st">'y'</span>, np.int32)]</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">154</span>]: arr <span class="op">=</span> np.zeros(<span class="dv">4</span>, dtype<span class="op">=</span>dtype)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">155</span>]: arr</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">155</span>]: </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>array([([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], <span class="dv">0</span>), ([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], <span class="dv">0</span>), ([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], <span class="dv">0</span>), ([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>], <span class="dv">0</span>)],</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>      dtype<span class="op">=</span>[(<span class="st">'x'</span>, <span class="st">'&lt;i8'</span>, (<span class="dv">3</span>,)), (<span class="st">'y'</span>, <span class="st">'&lt;i4'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this case, the <code>x</code> field now refers to an array of length 3 for each record:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">156</span>]: arr[<span class="dv">0</span>][<span class="st">'x'</span>]</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">156</span>]: array([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Conveniently, accessing <code>arr['x']</code> then returns a two-dimensional array instead of a one-dimensional array as in prior examples:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">157</span>]: arr[<span class="st">'x'</span>]</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">157</span>]: </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>array([[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>       [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This enables you to express more complicated, nested structures as a single block of memory in an array. You can also nest data types to make more complex structures. Here is an example:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">158</span>]: dtype <span class="op">=</span> [(<span class="st">'x'</span>, [(<span class="st">'a'</span>, <span class="st">'f8'</span>), (<span class="st">'b'</span>, <span class="st">'f4'</span>)]), (<span class="st">'y'</span>, np.int32)]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">159</span>]: data <span class="op">=</span> np.array([((<span class="dv">1</span>, <span class="dv">2</span>), <span class="dv">5</span>), ((<span class="dv">3</span>, <span class="dv">4</span>), <span class="dv">6</span>)], dtype<span class="op">=</span>dtype)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">160</span>]: data[<span class="st">'x'</span>]</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">160</span>]: array([(<span class="fl">1.</span>, <span class="fl">2.</span>), (<span class="fl">3.</span>, <span class="fl">4.</span>)], dtype<span class="op">=</span>[(<span class="st">'a'</span>, <span class="st">'&lt;f8'</span>), (<span class="st">'b'</span>, <span class="st">'&lt;f4'</span>)])</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">161</span>]: data[<span class="st">'y'</span>]</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">161</span>]: array([<span class="dv">5</span>, <span class="dv">6</span>], dtype<span class="op">=</span>int32)</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">162</span>]: data[<span class="st">'x'</span>][<span class="st">'a'</span>]</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">162</span>]: array([<span class="fl">1.</span>, <span class="fl">3.</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>pandas DataFrame does not support this feature in the same way, though it is similar to hierarchical indexing.</p>
</section>
<section id="numpy_why_structured_arrays" class="level3">
<h3 class="anchored" data-anchor-id="numpy_why_structured_arrays">Why Use Structured Arrays?</h3>
<p>Compared with a pandas DataFrame, NumPy structured arrays are a lower level tool. They provide a means to interpret a block of memory as a tabular structure with nested columns. Since each element in the array is represented in memory as a fixed number of bytes, structured arrays provide an efficient way of writing data to and from disk (including memory maps), transporting it over the network, and other such uses. The memory layout of each value in a structured array is based on the binary representation of struct data types in the C programming language.</p>
<p>As another common use for structured arrays, writing data files as fixed-length record byte streams is a common way to serialize data in C and C++ code, which is sometimes found in legacy systems in industry. As long as the format of the file is known (the size of each record and the order, byte size, and data type of each element), the data can be read into memory with <code>np.fromfile</code>. Specialized uses like this are beyond the scope of this book, but it’s worth knowing that such things are possible.</p>
</section>
</section>
<section id="numpy_advanced_sorting" class="level2" data-number="A.6">
<h2 data-number="A.6" class="anchored" data-anchor-id="numpy_advanced_sorting"><span class="header-section-number">A.6</span> More About Sorting</h2>
<p>Like Python’s built-in list, the ndarray <code>sort</code> instance method is an <em>in-place</em> sort, meaning that the array contents are rearranged without producing a new array:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">163</span>]: arr <span class="op">=</span> rng.standard_normal(<span class="dv">6</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">164</span>]: arr.sort()</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">165</span>]: arr</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">165</span>]: array([<span class="op">-</span><span class="fl">1.1553</span>, <span class="op">-</span><span class="fl">0.9319</span>, <span class="op">-</span><span class="fl">0.5218</span>, <span class="op">-</span><span class="fl">0.4745</span>, <span class="op">-</span><span class="fl">0.1649</span>,  <span class="fl">0.03</span>  ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When sorting arrays in place, remember that if the array is a view on a different ndarray, the original array will be modified:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">166</span>]: arr <span class="op">=</span> rng.standard_normal((<span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">167</span>]: arr</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">167</span>]: </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>array([[<span class="op">-</span><span class="fl">1.1956</span>,  <span class="fl">0.4691</span>, <span class="op">-</span><span class="fl">0.3598</span>,  <span class="fl">1.0359</span>,  <span class="fl">0.2267</span>],</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.7448</span>, <span class="op">-</span><span class="fl">0.5931</span>, <span class="op">-</span><span class="fl">1.055</span> , <span class="op">-</span><span class="fl">0.0683</span>,  <span class="fl">0.458</span> ],</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.07</span>  ,  <span class="fl">0.1462</span>, <span class="op">-</span><span class="fl">0.9944</span>,  <span class="fl">1.1436</span>,  <span class="fl">0.5026</span>]])</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">168</span>]: arr[:, <span class="dv">0</span>].sort()  <span class="co"># Sort first column values in place</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">169</span>]: arr</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">169</span>]: </span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>array([[<span class="op">-</span><span class="fl">1.1956</span>,  <span class="fl">0.4691</span>, <span class="op">-</span><span class="fl">0.3598</span>,  <span class="fl">1.0359</span>,  <span class="fl">0.2267</span>],</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.7448</span>, <span class="op">-</span><span class="fl">0.5931</span>, <span class="op">-</span><span class="fl">1.055</span> , <span class="op">-</span><span class="fl">0.0683</span>,  <span class="fl">0.458</span> ],</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.07</span>  ,  <span class="fl">0.1462</span>, <span class="op">-</span><span class="fl">0.9944</span>,  <span class="fl">1.1436</span>,  <span class="fl">0.5026</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On the other hand, <code>numpy.sort</code> creates a new, sorted copy of an array. Otherwise, it accepts the same arguments (such as <code>kind</code>) as ndarray's <code>sort</code> method:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">170</span>]: arr <span class="op">=</span> rng.standard_normal(<span class="dv">5</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">171</span>]: arr</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">171</span>]: array([ <span class="fl">0.8981</span>, <span class="op">-</span><span class="fl">1.1704</span>, <span class="op">-</span><span class="fl">0.2686</span>, <span class="op">-</span><span class="fl">0.796</span> ,  <span class="fl">1.4522</span>])</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">172</span>]: np.sort(arr)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">172</span>]: array([<span class="op">-</span><span class="fl">1.1704</span>, <span class="op">-</span><span class="fl">0.796</span> , <span class="op">-</span><span class="fl">0.2686</span>,  <span class="fl">0.8981</span>,  <span class="fl">1.4522</span>])</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">173</span>]: arr</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">173</span>]: array([ <span class="fl">0.8981</span>, <span class="op">-</span><span class="fl">1.1704</span>, <span class="op">-</span><span class="fl">0.2686</span>, <span class="op">-</span><span class="fl">0.796</span> ,  <span class="fl">1.4522</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>All of these sort methods take an axis argument for independently sorting the sections of data along the passed axis:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">174</span>]: arr <span class="op">=</span> rng.standard_normal((<span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">175</span>]: arr</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">175</span>]: </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>array([[<span class="op">-</span><span class="fl">0.2535</span>,  <span class="fl">2.1183</span>,  <span class="fl">0.3634</span>, <span class="op">-</span><span class="fl">0.6245</span>,  <span class="fl">1.1279</span>],</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">1.6164</span>, <span class="op">-</span><span class="fl">0.2287</span>, <span class="op">-</span><span class="fl">0.6201</span>, <span class="op">-</span><span class="fl">0.1143</span>, <span class="op">-</span><span class="fl">1.2067</span>],</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">1.0872</span>, <span class="op">-</span><span class="fl">2.1518</span>, <span class="op">-</span><span class="fl">0.6287</span>, <span class="op">-</span><span class="fl">1.3199</span>,  <span class="fl">0.083</span> ]])</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">176</span>]: arr.sort(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">177</span>]: arr</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">177</span>]: </span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>array([[<span class="op">-</span><span class="fl">0.6245</span>, <span class="op">-</span><span class="fl">0.2535</span>,  <span class="fl">0.3634</span>,  <span class="fl">1.1279</span>,  <span class="fl">2.1183</span>],</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">1.2067</span>, <span class="op">-</span><span class="fl">0.6201</span>, <span class="op">-</span><span class="fl">0.2287</span>, <span class="op">-</span><span class="fl">0.1143</span>,  <span class="fl">1.6164</span>],</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">2.1518</span>, <span class="op">-</span><span class="fl">1.3199</span>, <span class="op">-</span><span class="fl">1.0872</span>, <span class="op">-</span><span class="fl">0.6287</span>,  <span class="fl">0.083</span> ]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You may notice that none of the sort methods have an option to sort in descending order. This is a problem in practice because array slicing produces views, thus not producing a copy or requiring any computational work. Many Python users are familiar with the “trick” that for a list of <code>values</code>, <code>values[::-1]</code> returns a list in reverse order. The same is true for ndarrays:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">178</span>]: arr[:, ::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">178</span>]: </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">2.1183</span>,  <span class="fl">1.1279</span>,  <span class="fl">0.3634</span>, <span class="op">-</span><span class="fl">0.2535</span>, <span class="op">-</span><span class="fl">0.6245</span>],</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">1.6164</span>, <span class="op">-</span><span class="fl">0.1143</span>, <span class="op">-</span><span class="fl">0.2287</span>, <span class="op">-</span><span class="fl">0.6201</span>, <span class="op">-</span><span class="fl">1.2067</span>],</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.083</span> , <span class="op">-</span><span class="fl">0.6287</span>, <span class="op">-</span><span class="fl">1.0872</span>, <span class="op">-</span><span class="fl">1.3199</span>, <span class="op">-</span><span class="fl">2.1518</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="numpy_indirect_sorts" class="level3">
<h3 class="anchored" data-anchor-id="numpy_indirect_sorts">Indirect Sorts: argsort and lexsort</h3>
<p>In data analysis you may need to reorder datasets by one or more keys. For example, a table of data about some students might need to be sorted by last name, then by first name. This is an example of an <em>indirect</em> sort, and if you’ve read the pandas-related chapters, you have already seen many higher-level examples. Given a key or keys (an array of values or multiple arrays of values), you wish to obtain an array of integer <em>indices</em> (I refer to them colloquially as <em>indexers</em>) that tells you how to reorder the data to be in sorted order. Two methods for this are <code>argsort</code> and <code>numpy.lexsort</code>. As an example:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">179</span>]: values <span class="op">=</span> np.array([<span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>])</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">180</span>]: indexer <span class="op">=</span> values.argsort()</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">181</span>]: indexer</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">181</span>]: array([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">0</span>])</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">182</span>]: values[indexer]</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">182</span>]: array([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As a more complicated example, this code reorders a two-dimensional array by its first row:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">183</span>]: arr <span class="op">=</span> rng.standard_normal((<span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">184</span>]: arr[<span class="dv">0</span>] <span class="op">=</span> values</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">185</span>]: arr</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">185</span>]: </span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">5.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">1.</span>    ,  <span class="fl">3.</span>    ,  <span class="fl">2.</span>    ],</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">0.7503</span>, <span class="op">-</span><span class="fl">2.1268</span>, <span class="op">-</span><span class="fl">1.391</span> , <span class="op">-</span><span class="fl">0.4922</span>,  <span class="fl">0.4505</span>],</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">0.8926</span>, <span class="op">-</span><span class="fl">1.0479</span>,  <span class="fl">0.9553</span>,  <span class="fl">0.2936</span>,  <span class="fl">0.5379</span>]])</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">186</span>]: arr[:, arr[<span class="dv">0</span>].argsort()]</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">186</span>]: </span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>array([[ <span class="fl">0.</span>    ,  <span class="fl">1.</span>    ,  <span class="fl">2.</span>    ,  <span class="fl">3.</span>    ,  <span class="fl">5.</span>    ],</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">2.1268</span>, <span class="op">-</span><span class="fl">1.391</span> ,  <span class="fl">0.4505</span>, <span class="op">-</span><span class="fl">0.4922</span>, <span class="op">-</span><span class="fl">0.7503</span>],</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>       [<span class="op">-</span><span class="fl">1.0479</span>,  <span class="fl">0.9553</span>,  <span class="fl">0.5379</span>,  <span class="fl">0.2936</span>,  <span class="fl">0.8926</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>lexsort</code> is similar to <code>argsort</code>, but it performs an indirect <em>lexicographical</em> sort on multiple key arrays. Suppose we wanted to sort some data identified by first and last names:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">187</span>]: first_name <span class="op">=</span> np.array([<span class="st">'Bob'</span>, <span class="st">'Jane'</span>, <span class="st">'Steve'</span>, <span class="st">'Bill'</span>, <span class="st">'Barbara'</span>])</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">188</span>]: last_name <span class="op">=</span> np.array([<span class="st">'Jones'</span>, <span class="st">'Arnold'</span>, <span class="st">'Arnold'</span>, <span class="st">'Jones'</span>, <span class="st">'Walters'</span>])</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">189</span>]: sorter <span class="op">=</span> np.lexsort((first_name, last_name))</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">190</span>]: sorter</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">190</span>]: array([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">4</span>])</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">191</span>]: <span class="bu">list</span>(<span class="bu">zip</span>(last_name[sorter], first_name[sorter]))</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">191</span>]: </span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>[(<span class="st">'Arnold'</span>, <span class="st">'Jane'</span>),</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a> (<span class="st">'Arnold'</span>, <span class="st">'Steve'</span>),</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a> (<span class="st">'Jones'</span>, <span class="st">'Bill'</span>),</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a> (<span class="st">'Jones'</span>, <span class="st">'Bob'</span>),</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a> (<span class="st">'Walters'</span>, <span class="st">'Barbara'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>lexsort</code> can be a bit confusing the first time you use it, because the order in which the keys are used to order the data starts with the <em>last</em> array passed. Here, <code>last_name</code> was used before <code>first_name</code>.</p>
</section>
<section id="numpy_more_sorting_methods" class="level3">
<h3 class="anchored" data-anchor-id="numpy_more_sorting_methods">Alternative Sort Algorithms</h3>
<p>A <em>stable</em> sorting algorithm preserves the relative position of equal elements. This can be especially important in indirect sorts where the relative ordering is meaningful:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">192</span>]: values <span class="op">=</span> np.array([<span class="st">'2:first'</span>, <span class="st">'2:second'</span>, <span class="st">'1:first'</span>, <span class="st">'1:second'</span>,</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>   .....:                    <span class="st">'1:third'</span>])</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">193</span>]: key <span class="op">=</span> np.array([<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">194</span>]: indexer <span class="op">=</span> key.argsort(kind<span class="op">=</span><span class="st">'mergesort'</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">195</span>]: indexer</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">195</span>]: array([<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">196</span>]: values.take(indexer)</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">196</span>]: </span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>array([<span class="st">'1:first'</span>, <span class="st">'1:second'</span>, <span class="st">'1:third'</span>, <span class="st">'2:first'</span>, <span class="st">'2:second'</span>],</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>      dtype<span class="op">=</span><span class="st">'&lt;U8'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The only stable sort available is <em>mergesort</em>, which has guaranteed <code>O(n log n)</code> performance, but its performance is on average worse than the default quicksort method. See <a href="#tbl-table_array_sort_methods">Table&nbsp;<span>A.3</span></a> for a summary of available methods and their relative performance (and performance guarantees). This is not something that most users will ever have to think about, but it's useful to know that it’s there.</p>
<div id="tbl-table_array_sort_methods" class="anchored">
<table class="table">
<caption>Table&nbsp;A.3: Array sorting methods</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Kind</th>
<th style="text-align: left;">Speed</th>
<th style="text-align: left;">Stable</th>
<th style="text-align: left;">Work space</th>
<th style="text-align: left;">Worst case</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>'quicksort'</code></td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;"><code>O(n^2)</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>'mergesort'</code></td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;"><code>n / 2</code></td>
<td style="text-align: left;"><code>O(n log n)</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>'heapsort'</code></td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;"><code>O(n log n)</code></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="numpy_partition" class="level3">
<h3 class="anchored" data-anchor-id="numpy_partition">Partially Sorting Arrays</h3>
<p>One of the goals of sorting can be to determine the largest or smallest elements in an array. NumPy has fast methods, <code>numpy.partition</code> and <code>np.argpartition</code>, for partitioning an array around the <code>k</code>-th smallest element:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">197</span>]: rng <span class="op">=</span> np.random.default_rng(<span class="dv">12345</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">198</span>]: arr <span class="op">=</span> rng.standard_normal(<span class="dv">20</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">199</span>]: arr</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">199</span>]: </span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>array([<span class="op">-</span><span class="fl">1.4238</span>,  <span class="fl">1.2637</span>, <span class="op">-</span><span class="fl">0.8707</span>, <span class="op">-</span><span class="fl">0.2592</span>, <span class="op">-</span><span class="fl">0.0753</span>, <span class="op">-</span><span class="fl">0.7409</span>, <span class="op">-</span><span class="fl">1.3678</span>,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.6489</span>,  <span class="fl">0.3611</span>, <span class="op">-</span><span class="fl">1.9529</span>,  <span class="fl">2.3474</span>,  <span class="fl">0.9685</span>, <span class="op">-</span><span class="fl">0.7594</span>,  <span class="fl">0.9022</span>,</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">0.467</span> , <span class="op">-</span><span class="fl">0.0607</span>,  <span class="fl">0.7888</span>, <span class="op">-</span><span class="fl">1.2567</span>,  <span class="fl">0.5759</span>,  <span class="fl">1.399</span> ])</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">200</span>]: np.partition(arr, <span class="dv">3</span>)</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">200</span>]: </span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>array([<span class="op">-</span><span class="fl">1.9529</span>, <span class="op">-</span><span class="fl">1.4238</span>, <span class="op">-</span><span class="fl">1.3678</span>, <span class="op">-</span><span class="fl">1.2567</span>, <span class="op">-</span><span class="fl">0.8707</span>, <span class="op">-</span><span class="fl">0.7594</span>, <span class="op">-</span><span class="fl">0.7409</span>,</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">0.0607</span>,  <span class="fl">0.3611</span>, <span class="op">-</span><span class="fl">0.0753</span>, <span class="op">-</span><span class="fl">0.2592</span>, <span class="op">-</span><span class="fl">0.467</span> ,  <span class="fl">0.5759</span>,  <span class="fl">0.9022</span>,</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.9685</span>,  <span class="fl">0.6489</span>,  <span class="fl">0.7888</span>,  <span class="fl">1.2637</span>,  <span class="fl">1.399</span> ,  <span class="fl">2.3474</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After you call <code>partition(arr, 3)</code>, the first three elements in the result are the smallest three values in no particular order. <code>numpy.argpartition</code>, similar to <code>numpy.argsort</code>, returns the indices that rearrange the data into the equivalent order:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">201</span>]: indices <span class="op">=</span> np.argpartition(arr, <span class="dv">3</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">202</span>]: indices</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">202</span>]: </span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>array([ <span class="dv">9</span>,  <span class="dv">0</span>,  <span class="dv">6</span>, <span class="dv">17</span>,  <span class="dv">2</span>, <span class="dv">12</span>,  <span class="dv">5</span>, <span class="dv">15</span>,  <span class="dv">8</span>,  <span class="dv">4</span>,  <span class="dv">3</span>, <span class="dv">14</span>, <span class="dv">18</span>, <span class="dv">13</span>, <span class="dv">11</span>,  <span class="dv">7</span>, <span class="dv">16</span>,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>, <span class="dv">19</span>, <span class="dv">10</span>])</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">203</span>]: arr.take(indices)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">203</span>]: </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>array([<span class="op">-</span><span class="fl">1.9529</span>, <span class="op">-</span><span class="fl">1.4238</span>, <span class="op">-</span><span class="fl">1.3678</span>, <span class="op">-</span><span class="fl">1.2567</span>, <span class="op">-</span><span class="fl">0.8707</span>, <span class="op">-</span><span class="fl">0.7594</span>, <span class="op">-</span><span class="fl">0.7409</span>,</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">0.0607</span>,  <span class="fl">0.3611</span>, <span class="op">-</span><span class="fl">0.0753</span>, <span class="op">-</span><span class="fl">0.2592</span>, <span class="op">-</span><span class="fl">0.467</span> ,  <span class="fl">0.5759</span>,  <span class="fl">0.9022</span>,</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.9685</span>,  <span class="fl">0.6489</span>,  <span class="fl">0.7888</span>,  <span class="fl">1.2637</span>,  <span class="fl">1.399</span> ,  <span class="fl">2.3474</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="numpy_searchsorted" class="level3">
<h3 class="anchored" data-anchor-id="numpy_searchsorted">numpy.searchsorted: Finding Elements in a Sorted Array</h3>
<p><code>searchsorted</code> is an array method that performs a binary search on a sorted array, returning the location in the array where the value would need to be inserted to maintain sortedness:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">204</span>]: arr <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">7</span>, <span class="dv">12</span>, <span class="dv">15</span>])</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">205</span>]: arr.searchsorted(<span class="dv">9</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">205</span>]: <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can also pass an array of values to get an array of indices back:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">206</span>]: arr.searchsorted([<span class="dv">0</span>, <span class="dv">8</span>, <span class="dv">11</span>, <span class="dv">16</span>])</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">206</span>]: array([<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You might have noticed that <code>searchsorted</code> returned <code>0</code> for the <code>0</code> element. This is because the default behavior is to return the index at the left side of a group of equal values:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">207</span>]: arr <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">208</span>]: arr.searchsorted([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">208</span>]: array([<span class="dv">0</span>, <span class="dv">3</span>])</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">209</span>]: arr.searchsorted([<span class="dv">0</span>, <span class="dv">1</span>], side<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">209</span>]: array([<span class="dv">3</span>, <span class="dv">7</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As another application of <code>searchsorted</code>, suppose we had an array of values between 0 and 10,000, and a separate array of “bucket edges” that we wanted to use to bin the data:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">210</span>]: data <span class="op">=</span> np.floor(rng.uniform(<span class="dv">0</span>, <span class="dv">10000</span>, size<span class="op">=</span><span class="dv">50</span>))</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">211</span>]: bins <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">5000</span>, <span class="dv">10000</span>])</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">212</span>]: data</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">212</span>]: </span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>array([ <span class="fl">815.</span>, <span class="fl">1598.</span>, <span class="fl">3401.</span>, <span class="fl">4651.</span>, <span class="fl">2664.</span>, <span class="fl">8157.</span>, <span class="fl">1932.</span>, <span class="fl">1294.</span>,  <span class="fl">916.</span>,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>       <span class="fl">5985.</span>, <span class="fl">8547.</span>, <span class="fl">6016.</span>, <span class="fl">9319.</span>, <span class="fl">7247.</span>, <span class="fl">8605.</span>, <span class="fl">9293.</span>, <span class="fl">5461.</span>, <span class="fl">9376.</span>,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>       <span class="fl">4949.</span>, <span class="fl">2737.</span>, <span class="fl">4517.</span>, <span class="fl">6650.</span>, <span class="fl">3308.</span>, <span class="fl">9034.</span>, <span class="fl">2570.</span>, <span class="fl">3398.</span>, <span class="fl">2588.</span>,</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>       <span class="fl">3554.</span>,   <span class="fl">50.</span>, <span class="fl">6286.</span>, <span class="fl">2823.</span>,  <span class="fl">680.</span>, <span class="fl">6168.</span>, <span class="fl">1763.</span>, <span class="fl">3043.</span>, <span class="fl">4408.</span>,</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>       <span class="fl">1502.</span>, <span class="fl">2179.</span>, <span class="fl">4743.</span>, <span class="fl">4763.</span>, <span class="fl">2552.</span>, <span class="fl">2975.</span>, <span class="fl">2790.</span>, <span class="fl">2605.</span>, <span class="fl">4827.</span>,</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>       <span class="fl">2119.</span>, <span class="fl">4956.</span>, <span class="fl">2462.</span>, <span class="fl">8384.</span>, <span class="fl">1801.</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To then get a labeling to which interval each data point belongs (where 1 would mean the bucket <code>[0, 100)</code>), we can simply use <code>searchsorted</code>:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">213</span>]: labels <span class="op">=</span> bins.searchsorted(data)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">214</span>]: labels</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">214</span>]: </span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>array([<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>       <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>       <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This, combined with pandas’s <code>groupby</code>, can be used to bin data:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">215</span>]: pd.Series(data).groupby(labels).mean()</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">215</span>]: </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>      <span class="fl">50.000000</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>     <span class="fl">803.666667</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>    <span class="fl">3079.741935</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>    <span class="fl">7635.200000</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>dtype: float64</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="numpy_numba" class="level2" data-number="A.7">
<h2 data-number="A.7" class="anchored" data-anchor-id="numpy_numba"><span class="header-section-number">A.7</span> Writing Fast NumPy Functions with Numba</h2>
<p><a href="http://numba.pydata.org">Numba</a> is an open source project that creates fast functions for NumPy-like data using CPUs, GPUs, or other hardware. It uses the <a href="http://llvm.org/">LLVM Project</a> to translate Python code into compiled machine code.</p>
<p>To introduce Numba, let's consider a pure Python function that computes the expression <code>(x - y).mean()</code> using a <code>for</code> loop:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mean_distance(x, y):</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    nx <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(nx):</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>        result <span class="op">+=</span> x[i] <span class="op">-</span> y[i]</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result <span class="op">/</span> count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This function is slow:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">209</span>]: x <span class="op">=</span> rng.standard_normal(<span class="dv">10_000_000</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">210</span>]: y <span class="op">=</span> rng.standard_normal(<span class="dv">10_000_000</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">211</span>]: <span class="op">%</span>timeit mean_distance(x, y)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> loop, best of <span class="dv">3</span>: <span class="dv">2</span> s per loop</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">212</span>]: <span class="op">%</span>timeit (x <span class="op">-</span> y).mean()</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="dv">100</span> loops, best of <span class="dv">3</span>: <span class="fl">14.7</span> ms per loop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The NumPy version is over 100 times faster. We can turn this function into a compiled Numba function using the <code>numba.jit</code> function:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">213</span>]: <span class="im">import</span> numba <span class="im">as</span> nb</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">214</span>]: numba_mean_distance <span class="op">=</span> nb.jit(mean_distance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We also could have written this as a decorator:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="at">@nb.jit</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> numba_mean_distance(x, y):</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    nx <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(nx):</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>        result <span class="op">+=</span> x[i] <span class="op">-</span> y[i]</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result <span class="op">/</span> count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The resulting function is actually faster than the vectorized NumPy version:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">215</span>]: <span class="op">%</span>timeit numba_mean_distance(x, y)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="dv">100</span> loops, best of <span class="dv">3</span>: <span class="fl">10.3</span> ms per loop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Numba cannot compile all pure Python code, but it supports a significant subset of Python that is most useful for writing numerical algorithms.</p>
<p>Numba is a deep library, supporting different kinds of hardware, modes of compilation, and user extensions. It is also able to compile a substantial subset of the NumPy Python API without explicit <code>for</code> loops. Numba is able to recognize constructs that can be compiled to machine code, while substituting calls to the CPython API for functions that it does not know how to compile. Numba's <code>jit</code> function option, <code>nopython=True</code>, restricts allowed code to Python code that can be compiled to LLVM without any Python C API calls. <code>jit(nopython=True)</code> has a shorter alias, <code>numba.njit</code>.</p>
<p>In the previous example, we could have written:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numba <span class="im">import</span> float64, njit</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="at">@njit</span>(float64(float64[:], float64[:]))</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mean_distance(x, y):</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (x <span class="op">-</span> y).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I encourage you to learn more by reading the <a href="http://numba.pydata.org/">online documentation for Numba</a>. The next section shows an example of creating custom NumPy ufunc objects.</p>
<section id="numpy_numba_ufunc" class="level3">
<h3 class="anchored" data-anchor-id="numpy_numba_ufunc">Creating Custom numpy.ufunc Objects with Numba</h3>
<p>The <code>numba.vectorize</code> function creates compiled NumPy ufuncs, which behave like built-in ufuncs. Let's consider a Python implementation of <code>numpy.add</code>:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numba <span class="im">import</span> vectorize</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="at">@vectorize</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nb_add(x, y):</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we have:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">13</span>]: x <span class="op">=</span> np.arange(<span class="dv">10</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">14</span>]: nb_add(x, x)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">14</span>]: array([  <span class="fl">0.</span>,   <span class="fl">2.</span>,   <span class="fl">4.</span>,   <span class="fl">6.</span>,   <span class="fl">8.</span>,  <span class="fl">10.</span>,  <span class="fl">12.</span>,  <span class="fl">14.</span>,  <span class="fl">16.</span>,  <span class="fl">18.</span>])</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">15</span>]: nb_add.accumulate(x, <span class="dv">0</span>)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">15</span>]: array([  <span class="fl">0.</span>,   <span class="fl">1.</span>,   <span class="fl">3.</span>,   <span class="fl">6.</span>,  <span class="fl">10.</span>,  <span class="fl">15.</span>,  <span class="fl">21.</span>,  <span class="fl">28.</span>,  <span class="fl">36.</span>,  <span class="fl">45.</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="numpy_io_advanced" class="level2" data-number="A.8">
<h2 data-number="A.8" class="anchored" data-anchor-id="numpy_io_advanced"><span class="header-section-number">A.8</span> Advanced Array Input and Output</h2>
<p>In <a href='/book/numpy-basics'>Ch 4: NumPy Basics: Arrays and Vectorized Computation</a>, we became acquainted with <code>np.save</code> and <code>np.load</code> for storing arrays in binary format on disk. There are a number of additional options to consider for more sophisticated use. In particular, memory maps have the additional benefit of enabling you to do certain operations with datasets that do not fit into RAM.</p>
<section id="numpy_memmap" class="level3">
<h3 class="anchored" data-anchor-id="numpy_memmap">Memory-Mapped Files</h3>
<p>A <em>memory-mapped</em> file is a method for interacting with binary data on disk as though it is stored in an in-memory array. NumPy implements a <code>memmap</code> object that is ndarray-like, enabling small segments of a large file to be read and written without reading the whole array into memory. Additionally, a <code>memmap</code> has the same methods as an in-memory array and thus can be substituted into many algorithms where an ndarray would be expected.</p>
<p>To create a new memory map, use the function <code>np.memmap</code> and pass a file path, data type, shape, and file mode:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">217</span>]: mmap <span class="op">=</span> np.memmap(<span class="st">'mymmap'</span>, dtype<span class="op">=</span><span class="st">'float64'</span>, mode<span class="op">=</span><span class="st">'w+'</span>,</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>   .....:                  shape<span class="op">=</span>(<span class="dv">10000</span>, <span class="dv">10000</span>))</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">218</span>]: mmap</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">218</span>]: </span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>memmap([[<span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>, ..., <span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>],</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>, ..., <span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>],</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>, ..., <span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>],</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>        ...,</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>, ..., <span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>],</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>, ..., <span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>],</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>, ..., <span class="fl">0.</span>, <span class="fl">0.</span>, <span class="fl">0.</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Slicing a <code>memmap</code> returns views on the data on disk:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">219</span>]: section <span class="op">=</span> mmap[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you assign data to these, it will be buffered in memory, which means that the changes will not be immediately reflected in the on-disk file if you were to read the file in a different application. Any modifications can be synchronized to disk by calling <code>flush</code>:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">220</span>]: section[:] <span class="op">=</span> rng.standard_normal((<span class="dv">5</span>, <span class="dv">10000</span>))</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">221</span>]: mmap.flush()</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">222</span>]: mmap</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">222</span>]: </span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>memmap([[<span class="op">-</span><span class="fl">0.9074</span>, <span class="op">-</span><span class="fl">1.0954</span>,  <span class="fl">0.0071</span>, ...,  <span class="fl">0.2753</span>, <span class="op">-</span><span class="fl">1.1641</span>,  <span class="fl">0.8521</span>],</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>        [<span class="op">-</span><span class="fl">0.0103</span>, <span class="op">-</span><span class="fl">0.0646</span>, <span class="op">-</span><span class="fl">1.0615</span>, ..., <span class="op">-</span><span class="fl">1.1003</span>,  <span class="fl">0.2505</span>,  <span class="fl">0.5832</span>],</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.4583</span>,  <span class="fl">1.2992</span>,  <span class="fl">1.7137</span>, ...,  <span class="fl">0.8691</span>, <span class="op">-</span><span class="fl">0.7889</span>, <span class="op">-</span><span class="fl">0.2431</span>],</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>        ...,</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    , ...,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ],</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    , ...,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ],</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    , ...,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ]])</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">223</span>]: <span class="kw">del</span> mmap</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Whenever a memory map falls out of scope and is garbage collected, any changes will be flushed to disk also. When <em>opening an existing memory map</em>, you still have to specify the data type and shape, as the file is only a block of binary data without any data type information, shape, or strides:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">224</span>]: mmap <span class="op">=</span> np.memmap(<span class="st">'mymmap'</span>, dtype<span class="op">=</span><span class="st">'float64'</span>, shape<span class="op">=</span>(<span class="dv">10000</span>, <span class="dv">10000</span>))</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">225</span>]: mmap</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">225</span>]: </span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>memmap([[<span class="op">-</span><span class="fl">0.9074</span>, <span class="op">-</span><span class="fl">1.0954</span>,  <span class="fl">0.0071</span>, ...,  <span class="fl">0.2753</span>, <span class="op">-</span><span class="fl">1.1641</span>,  <span class="fl">0.8521</span>],</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>        [<span class="op">-</span><span class="fl">0.0103</span>, <span class="op">-</span><span class="fl">0.0646</span>, <span class="op">-</span><span class="fl">1.0615</span>, ..., <span class="op">-</span><span class="fl">1.1003</span>,  <span class="fl">0.2505</span>,  <span class="fl">0.5832</span>],</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.4583</span>,  <span class="fl">1.2992</span>,  <span class="fl">1.7137</span>, ...,  <span class="fl">0.8691</span>, <span class="op">-</span><span class="fl">0.7889</span>, <span class="op">-</span><span class="fl">0.2431</span>],</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>        ...,</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    , ...,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ],</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    , ...,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ],</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    , ...,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ,  <span class="fl">0.</span>    ]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Memory maps also work with structured or nested data types, as described in <a href="#numpy_structured">Structured and Record Arrays</a>.</p>
<p>If you ran this example on your computer, you may want to delete the large file that we created above:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">226</span>]: <span class="op">%</span>xdel mmap</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">227</span>]: <span class="op">!</span>rm mymmap</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="numpy_other_hdf5" class="level3">
<h3 class="anchored" data-anchor-id="numpy_other_hdf5">HDF5 and Other Array Storage Options</h3>
<p>PyTables and h5py are two Python projects providing NumPy-friendly interfaces for storing array data in the efficient and compressible HDF5 format (HDF stands for <em>hierarchical data format</em>). You can safely store hundreds of gigabytes or even terabytes of data in HDF5 format. To learn more about using HDF5 with Python, I recommend reading the <a href="http://pandas.pydata.org">pandas online documentation</a>.</p>
</section>
</section>
<section id="numpy_performance_quirks" class="level2" data-number="A.9">
<h2 data-number="A.9" class="anchored" data-anchor-id="numpy_performance_quirks"><span class="header-section-number">A.9</span> Performance Tips</h2>
<p>Adapting data processing code to use NumPy generally makes things much faster, as array operations typically replace otherwise comparatively extremely slow pure Python loops. Here are some tips to help get the best performance out of the library:</p>
<ul>
<li><p>Convert Python loops and conditional logic to array operations and Boolean array operations.</p></li>
<li><p>Use broadcasting whenever possible.</p></li>
<li><p>Use arrays views (slicing) to avoid copying data.</p></li>
<li><p>Utilize ufuncs and ufunc methods.</p></li>
</ul>
<p>If you can’t get the performance you require after exhausting the capabilities provided by NumPy alone, consider writing code in C, FORTRAN, or Cython. I use <a href="http://cython.org">Cython</a> frequently in my own work as a way to get C-like performance, often with much less development time.</p>
<section id="numpy_contiguousness" class="level3">
<h3 class="anchored" data-anchor-id="numpy_contiguousness">The Importance of Contiguous Memory</h3>
<p>While the full extent of this topic is a bit outside the scope of this book, in some applications the memory layout of an array can significantly affect the speed of computations. This is based partly on performance differences having to do with the cache hierarchy of the CPU; operations accessing contiguous blocks of memory (e.g., summing the rows of a C order array) will generally be the fastest because the memory subsystem will buffer the appropriate blocks of memory into the low latency L1 or L2 CPU caches. Also, certain code paths inside NumPy’s C codebase have been optimized for the contiguous case in which generic strided memory access can be avoided.</p>
<p>To say that an array’s memory layout is <em>contiguous</em> means that the elements are stored in memory in the order that they appear in the array with respect to FORTRAN (column major) or C (row major) ordering. By default, NumPy arrays are created as C contiguous or just simply contiguous. A column major array, such as the transpose of a C-contiguous array, is thus said to be FORTRAN contiguous. These properties can be explicitly checked via the <code>flags</code> attribute on the ndarray:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">228</span>]: arr_c <span class="op">=</span> np.ones((<span class="dv">100</span>, <span class="dv">10000</span>), order<span class="op">=</span><span class="st">'C'</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">229</span>]: arr_f <span class="op">=</span> np.ones((<span class="dv">100</span>, <span class="dv">10000</span>), order<span class="op">=</span><span class="st">'F'</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">230</span>]: arr_c.flags</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">230</span>]: </span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>  C_CONTIGUOUS : <span class="va">True</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>  F_CONTIGUOUS : <span class="va">False</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>  OWNDATA : <span class="va">True</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>  WRITEABLE : <span class="va">True</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>  ALIGNED : <span class="va">True</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>  WRITEBACKIFCOPY : <span class="va">False</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">231</span>]: arr_f.flags</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">231</span>]: </span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>  C_CONTIGUOUS : <span class="va">False</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>  F_CONTIGUOUS : <span class="va">True</span></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>  OWNDATA : <span class="va">True</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>  WRITEABLE : <span class="va">True</span></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>  ALIGNED : <span class="va">True</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>  WRITEBACKIFCOPY : <span class="va">False</span></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">232</span>]: arr_f.flags.f_contiguous</span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">232</span>]: <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this example, summing the rows of these arrays should, in theory, be faster for <code>arr_c</code> than <code>arr_f</code> since the rows are contiguous in memory. Here, I check using <code>%timeit</code> in IPython (these results may differ on your machine):</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">233</span>]: <span class="op">%</span>timeit arr_c.<span class="bu">sum</span>(<span class="dv">1</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="dv">199</span> us <span class="op">+-</span> <span class="fl">1.18</span> us per loop (mean <span class="op">+-</span> std. dev. of <span class="dv">7</span> runs, <span class="dv">1000</span> loops each)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">234</span>]: <span class="op">%</span>timeit arr_f.<span class="bu">sum</span>(<span class="dv">1</span>)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="dv">371</span> us <span class="op">+-</span> <span class="fl">6.77</span> us per loop (mean <span class="op">+-</span> std. dev. of <span class="dv">7</span> runs, <span class="dv">1000</span> loops each)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When you're looking to squeeze more performance out of NumPy, this is often a place to invest some effort. If you have an array that does not have the desired memory order, you can use <code>copy</code> and pass either <code>'C'</code> or <code>'F'</code>:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">235</span>]: arr_f.copy(<span class="st">'C'</span>).flags</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">235</span>]: </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  C_CONTIGUOUS : <span class="va">True</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  F_CONTIGUOUS : <span class="va">False</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  OWNDATA : <span class="va">True</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>  WRITEABLE : <span class="va">True</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  ALIGNED : <span class="va">True</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  WRITEBACKIFCOPY : <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When constructing a view on an array, keep in mind that the result is not guaranteed to be contiguous:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">236</span>]: arr_c[:<span class="dv">50</span>].flags.contiguous</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">236</span>]: <span class="va">True</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">237</span>]: arr_c[:, :<span class="dv">50</span>].flags</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">237</span>]: </span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>  C_CONTIGUOUS : <span class="va">False</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>  F_CONTIGUOUS : <span class="va">False</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  OWNDATA : <span class="va">False</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>  WRITEABLE : <span class="va">True</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>  ALIGNED : <span class="va">True</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>  WRITEBACKIFCOPY : <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>Some of the data types have trailing underscores in their names. These are there to avoid variable name conflicts between the NumPy-specific types and the Python built-in ones.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

<script async="" defer="" src="https://scripts.simpleanalyticscdn.com/latest.js"></script></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a class='pagination-link' href='/book/data-analysis-examples'>
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Data Analysis Examples</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a class='pagination-link' href='/book/ipython'>
        <span class="nav-page-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">More on the IPython System</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2023, Wes McKinney. All Rights Reserved.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/wesmckinn">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script async="" src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>



</body></html>